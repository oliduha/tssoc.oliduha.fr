<!DOCTYPE html>
<html lang="fr" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="Docs formation Cefim TSSR">
    <meta name="author" content="Olivier Duhamel">
    <title>Maintenir, exploiter et sécuriser une infrastructure centralisée - TSSOC</title>
    <link href="https://www.tssoc.oliduha.fr/at2/index.html" rel="canonical" type="text/html" title="Maintenir, exploiter et sécuriser une infrastructure centralisée - TSSOC">
    <link href="../at2/index.xml" rel="alternate" type="application/rss+xml" title="Maintenir, exploiter et sécuriser une infrastructure centralisée - TSSOC">
    <link href="../images/logo.svg" rel="icon" type="image/svg+xml">
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="../css/fontawesome-all.min.css" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../css/fontawesome-all.min.css" rel="stylesheet"></noscript>
    <link href="../css/nucleus.css" rel="stylesheet">
    <link href="../css/auto-complete.css" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../css/auto-complete.css" rel="stylesheet"></noscript>
    <link href="../css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="../css/fonts.css" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../css/fonts.css" rel="stylesheet"></noscript>
    <link href="../css/theme.css" rel="stylesheet">
    <link href="../css/theme-auto.css" rel="stylesheet" id="variant-style">
    <link href="../css/variant.css" rel="stylesheet">
    <link href="../css/print.css" rel="stylesheet" media="print">
    <link href="../css/format-print.css" rel="stylesheet">
    <link href="../css/ie.css" rel="stylesheet">
    <script src="../js/url.js"></script>
    <script src="../js/variant.js"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      window.index_js_url="../index.search.js";
      var root_url="../";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copier dans le presse-papiers';
      window.T_Copied_to_clipboard = 'Copié dans le presse-papiers !';
      window.T_Copy_link_to_clipboard = 'Copier le lien dans le presse-papiers';
      window.T_Link_copied_to_clipboard = 'Lien copié dans le presse-papiers !';
      window.T_No_results_found = 'Aucun résultat trouvé pour \u0022{0}\u0022';
      window.T_N_results_found = '{1} résultats trouvés pour \u0022{0}\u0022';
      // some further base stuff
      var baseUriFull='https:\/\/www.tssoc.oliduha.fr/';
      window.variants && variants.init( [ 'auto', 'relearn-bright', 'relearn-light', 'relearn-dark', 'learn', 'neon', 'blue', 'green', 'red' ] );
    </script>
    <style>
      #body img.bg-white {
        background-color: white;
      }
    </style>
  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../at2/index.html">
    <div id="body" class="default-animation">
      <div id="sidebar-overlay"></div>
      <div id="toc-overlay"></div>
      <nav id="topbar" class="highlightable">
        <div>
          <div id="breadcrumbs">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" class="topbar-link" title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a>
            </span>
            <ol class="links" itemscope itemtype="http://schema.org/BreadcrumbList">
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../index.html"><span itemprop="name">TSSOC</span></a><meta itemprop="position" content="1"> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Maintenir, exploiter et sécuriser une infrastructure centralisée</span><meta itemprop="position" content="2"></li>
            </ol>
          </div>
        </div>
      </nav>
      <main id="body-inner" class="highlightable chapter narrow" tabindex="-1">
        <div class="flex-block-wrapper">
          <div id="head-tags">
          </div>
          <article class="chapter">
<div class="article-subheading">Activité-Type 2</div>
<h1 id="maintenir-exploiter-et-sécuriser-une-infrastructure-centralisée">Maintenir, exploiter et sécuriser une infrastructure centralisée</h1>

<hr>
<h4 id="1-maintenir-et-exploiter-le-réseau-local-et-la-téléphonieat2at2e1">1. <a href="../at2/at2e1/">Maintenir et exploiter le réseau local et la téléphonie</a></h4>
<h4 id="2-sécuriser-les-accès-à-internetat2at2e2">2. <a href="../at2/at2e2/">Sécuriser les accès à Internet</a></h4>
<h4 id="3-maintenir-et-exploiter-un-serveur-linuxat2at2e3">3. <a href="../at2/at2e3/">Maintenir et exploiter un serveur Linux</a></h4>
<h4 id="4-maintenir-et-exploiter-un-environnement-virtualiséat2at2e4">4. <a href="../at2/at2e4/">Maintenir et exploiter un environnement virtualisé</a></h4>
<h4 id="5-maintenir-et-exploiter-un-domaine-active-directory-et-les-serveurs-windowsat2at2e5">5. <a href="../at2/at2e5/">Maintenir et exploiter un domaine Active Directory et les serveurs Windows</a></h4>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Sous-sections de Maintenir, exploiter et sécuriser une infrastructure centralisée</h1>
          <article class="chapter">
<div class="article-subheading">Chapitre 1</div>
<h1 id="maintenir-et-exploiter-le-réseau-local-et-la-téléphonie">Maintenir et exploiter le réseau local et la téléphonie</h1>

<hr>
<h4 id="1-réseau-localat2at2e1reseau-local">1. <a href="../at2/at2e1/reseau-local/">Réseau local</a></h4>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Sous-sections de Maintenir et exploiter le réseau local et la téléphonie</h1>
          <article class="chapter">
<div class="article-subheading">Exemple 1</div>
<h1 id="réseau-local">Réseau local</h1>

<hr>
<h3 id="pi-hole">Pi-Hole</h3>
<p>Une capture d&rsquo;écran après plusieurs mois d&rsquo;utilisation :

<a href="#image-1c9865464f58820b83eb44b0c17157b9" class="lightbox-link">
<img src="../at2/at2e1/reseau-local/pi-hole.png" alt="Pi-Hole" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-1c9865464f58820b83eb44b0c17157b9">
<img src="../at2/at2e1/reseau-local/pi-hole.png" alt="Pi-Hole" class="lightbox-image" loading="lazy">
</a></p>
<hr>
<h3 id="fwknop">FwKnop</h3>
<p>L&rsquo;interface utilisateur sous Windows :

<a href="#image-e562711b24e28c57b08eff7374512dd4" class="lightbox-link">
<img src="../at2/at2e1/reseau-local/fwknop-gui.png" alt="FwKnop" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e562711b24e28c57b08eff7374512dd4">
<img src="../at2/at2e1/reseau-local/fwknop-gui.png" alt="FwKnop" class="lightbox-image" loading="lazy">
</a></p>
<p>Ouverture et fermeture du port ssh par FwKnop dans iptables :

<a href="#image-46e8408de87f58f51694c042d5a8d5ec" class="lightbox-link">
<img src="../at2/at2e1/reseau-local/Deb-min_fwknop_iptables.png" alt="Deb-min fwknop iptables" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-46e8408de87f58f51694c042d5a8d5ec">
<img src="../at2/at2e1/reseau-local/Deb-min_fwknop_iptables.png" alt="Deb-min fwknop iptables" class="lightbox-image" loading="lazy">
</a></p>
<p><em>Il faut initier la connexion ssh pendant que le port est ouvert, FxKnop refermant le port automatiquement à la fin du timeout défini. Si la connexion est effective, elle le reste une fois le port refermé.</em></p>
<hr>
<h3 id="lynis">Lynis</h3>
<p>Audit, renforcement des systèmes, tests de conformité</p>
<p>Lynis est un outil de sécurité éprouvé pour les systèmes fonctionnant sous Linux, macOS ou Unix. Il effectue une analyse approfondie de l&rsquo;état de santé de vos systèmes afin de soutenir le durcissement du système et les tests de conformité. Le projet est un logiciel open source sous licence GPL, disponible depuis 2007.</p>
<p>Lynis en cours d&rsquo;audit :

<a href="#image-5ef7b8f0cae4cc98b747502354c0a14c" class="lightbox-link">
<img src="../at2/at2e1/reseau-local/lynis-screenshot.png" alt="lynis audit" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5ef7b8f0cae4cc98b747502354c0a14c">
<img src="../at2/at2e1/reseau-local/lynis-screenshot.png" alt="lynis audit" class="lightbox-image" loading="lazy">
</a></p>
<p>Résultat :

<a href="#image-9fff001846d89e44b17e405f3f55d132" class="lightbox-link">
<img src="../at2/at2e1/reseau-local/lynis-res.png" alt="lynis result" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9fff001846d89e44b17e405f3f55d132">
<img src="../at2/at2e1/reseau-local/lynis-res.png" alt="lynis result" class="lightbox-image" loading="lazy">
</a></p>
<p><em>Après résolution de bon nombre d&rsquo;avertissements en suivant les conseils prodigués, l&rsquo;indice de durcissement de ma machine sous Linux Bodhi 6 a atteint un score de 85.</em></p>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="chapter">
<div class="article-subheading">Chapitre 2</div>
<h1 id="sécuriser-les-accès-à-internet">Sécuriser les accès à Internet</h1>

<hr>
<h4 id="1-stage-cefimat2at2e2stage-cefim">1. <a href="../at2/at2e2/stage-cefim/">Stage Cefim</a></h4>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Sous-sections de Sécuriser les accès à Internet</h1>
          <article class="chapter">
<div class="article-subheading">Exemple 1</div>
<h1 id="stage-cefim">Stage Cefim</h1>

<h2 id="automatisation-vouchers-cefim_pedago"><strong>Automatisation vouchers CEFIM_PEDAGO</strong></h2>
<p><em><strong>Les vouchers sont des codes d&rsquo;accès temporaires à un réseau WiFi sécurisé.</strong></em></p>
<hr>
<h2 id="mission-initiale">Mission initiale</h2>
<p>Simplifier l&rsquo;extraction de vouchers pour connexion au réseau WiFi CEFIM_PEDAGO des utilisateurs apportant leur propre matériel (ordinateur, tablette, smartphone).</p>
<hr>
<h2 id="contexte">Contexte</h2>
<p>Dans les locaux du CEFIM, le réseau WiFi CEFIM_PEDAGO est utilisé par la majorité des étudiants, formateurs, intervenants extérieurs et jurys.</p>
<p>L&rsquo;accès courant au réseau est autorisé par un système de filtrage MAC au niveau du portail captif de la passerelle/pare-feu (pfSense).
Les adresses MAC des machines CEFIM (pc/mac) fournies aux étudiants et formateurs internes sont enregistrées dans la configuration du portail captif.</p>
<p>Pour autoriser la connexion d&rsquo;une machine inconnue du portail captif, un système d&rsquo;authentification par vouchers est mis en place au niveau du portail captif.
Il s&rsquo;agit de séries (appelées Rolls) de codes d&rsquo;accès temporaires générés manuellement dans l&rsquo;interface web du pfSense (menu &lsquo;Services&rsquo; &gt; &lsquo;Captive Portal&rsquo; &gt; &lsquo;Edit Zone&rsquo; &gt; &lsquo;Vouchers&rsquo;).</p>
<p>En général, une série de 1000 vouchers valides pendant cinq jours est générée par l&rsquo;administrateur quand la série précédente arrive à épuisement.
La série générée est téléchargée depuis l&rsquo;interface web du pfSense au format .csv puis importée dans un google sheet partagé.</p>
<p>Lorsqu&rsquo;un groupe d&rsquo;utilisateur a besoin de se connecter temporairement à Internet avec des machines non connues du portail captif, il faut lui fournir une liste de vouchers (1 par personne).
Pour cela, un opérateur doit renseigner les divers éléments du tableau (le statut réservé, son nom, la date et le nom du groupe ou de la personne) pour chaque voucher, puis copier le nombre de codes souhaités depuis le tableau partagé et les coller dans un autre document (tableur ou texte) qu&rsquo;il doit ensuite imprimer.
L&rsquo;utilisateur final peut ainsi se connecter au réseau en renseignant le voucher qui lui est ainsi fourni lorsque le portail captif lui demande.</p>
<hr>
<h2 id="problèmes-relevés">Problèmes relevés</h2>
<ol>
<li>Plusieurs manipulations sont nécessaires pour imprimer les vouchers.</li>
<li>Les opérateurs n&rsquo;utilisent pas toujours des codes contigus dans la liste, rendant parfois encore plus fastidieuses les extractions ultérieures.</li>
<li>L&rsquo;administrateur doit surveiller l&rsquo;évolution de l&rsquo;utilisation de la liste de vouchers afin d&rsquo;en générer de nouveau lorsqu&rsquo;elle arrive à épuisement.</li>
<li>Les vouchers sont le plus souvent attribués à des groupes d&rsquo;utilisateurs. Une fois la formation terminée il n&rsquo;y a aucun moyen de relier un utilisateur au code de connexion utilisé, ce qui représente un risque légal.</li>
<li>Une partie des vouchers n&rsquo;a pas été utilisée une fois la formation terminée, ce qui représente un autre risque car ces codes se retrouvent alors &ldquo;dans la nature&rdquo;.</li>
</ol>
<hr>
<h2 id="objectifs-fonctionnels">Objectifs fonctionnels</h2>
<ul>
<li>Simplifier et rationaliser le système.</li>
<li>Avertir l&rsquo;administrateur lorsque la liste de vouchers atteint un seuil critique.</li>
<li>Relier les utilisateurs aux vouchers qu&rsquo;ils ont utilisé.</li>
<li>Invalider les vouchers non utilisés.</li>
</ul>
<hr>
<h2 id="solution-envisagée">Solution envisagée</h2>
<p>Développer un script &lsquo;Apps Script&rsquo; (le langage de script Google Workspace - une version de javascript spécifiquement développée par Google) qui devra :</p>
<ul>
<li>Afficher un formulaire simplifiant la saisie des informations nécessaires à l&rsquo;extraction par les opérateurs.</li>
<li>Extraire et réserver le nombre de vouchers nécessaires de la liste.</li>
<li>Créer un Google Document présentant les vouchers mis en page, pret à être imprimé (mais éditable si besoin).</li>
<li>Envoyer un email d&rsquo;alerte à l&rsquo;administrateur lorsque la liste de vouchers disponibles arrive à épuisement.</li>
</ul>
<p>Fonctionnalité supplémentaire : Disposer d&rsquo;une liste de secours afin de simplifier l&rsquo;ajout de vouchers par l&rsquo;admin s&rsquo;il n&rsquo;est pas présent sur site (en congés, en déplacement, etc.) lorsque la liste courante arrive à épuisement.</p>
<p>L&rsquo;invalidation des vouchers non utilisés n&rsquo;est possible que par l&rsquo;intermédiaire de l&rsquo;interface web du pfSense et donc relève de la responsabilité de l&rsquo;administrateur. Il faut simplement intégrer cette opération dans une procédure de maintenance.</p>
<hr>
<h2 id="prérequis">Prérequis</h2>
<p>Arborescence Google Drive :</p>
<ul>
<li>1 dossier principal Google Drive partagé avec :
<ul>
<li>1 sous-dossier accessible uniquement par l&rsquo;administrateur.</li>
<li>1 sous-dossier partagé</li>
</ul>
</li>
</ul>
<p>Documents Google :</p>
<ul>
<li>1 Google Sheet dans le dossier principal contenant la liste courante de vouchers disponibles. Le partage de ce fichier doit être nominatif (l&rsquo;accès nécessite une connection aux services Google). Il contiendra :
<ul>
<li>1 feuille de calcul pour la liste des vouchers disponible.</li>
<li>1 feuille de calcul pour la liste des vouchers utilisés.</li>
<li>1 feuille de calcul masquée contenant les paramètres généraux des scripts :
<ul>
<li>L&rsquo;Id du modèle de document.</li>
<li>L&rsquo;Id du sous-dossier contenant les documents générés.</li>
<li>L&rsquo;adresse email de l&rsquo;administrateur.</li>
<li>Le seuil d&rsquo;alerte.</li>
</ul>
</li>
</ul>
</li>
<li>1 modèle Google Document dans le dossier principal pour impression des vouchers sur demande contenant :
<ul>
<li>Le logo du CEFIM.</li>
<li>1 emplacement pour le nom du groupe ou de la personne.</li>
<li>1 emplacement pour la date.</li>
<li>1 tableau sur 2 colonnes avec :
<ul>
<li>1 ligne de titres</li>
<li>25 lignes avec chacune 1 emplacement pour un voucher dans la 1ère colonne et 1 cellule vide pour recevoir les nom et prénom de l&rsquo;utilisateur dans la 2ème colonne.</li>
</ul>
</li>
<li>Un message &ldquo;Bonne formation&rdquo; sous le tableau.</li>
</ul>
</li>
<li>1 Google Sheet dans le dossier privé contenant la liste des vouchers de secours.</li>
</ul>
<hr>
<h2 id="mise-en-oeuvre">Mise en oeuvre</h2>
<h3 id="côté-serveur">Côté serveur</h3>
<p>Un script serveur attaché à la liste courante qui implémente les fonctionnalités suivantes :</p>
<ul>
<li>Ajout d&rsquo;un menu permettant d&rsquo;afficher le formulaire de demande de vouchers.</li>
<li>Ajout d&rsquo;un déclencheur personnalisé affichant le formulaire à l&rsquo;ouverture de la feuille de calcul.</li>
<li>Le formulaire est affiché de manière modale.</li>
<li>Post-traitement du formulaire :
<ul>
<li>Récupération des données saisies.</li>
<li>Récupération de l&rsquo;adresse email de l&rsquo;opérateur.</li>
<li>Extraction du nombre de vouchers demandés vers une autre feuille de calcul avec les infos de réservation.</li>
<li>Mise en forme des données déplacées.</li>
<li>Création d&rsquo;un Google Document à partir d&rsquo;un modèle.</li>
<li>Insertions des données dans le Document.</li>
<li>Suppression des éléments inutiles.</li>
<li>enregistrement du Document dans un sous-dossier spécifique du Drive.</li>
<li>Affichage du lien vers le Document généré.</li>
</ul>
</li>
<li>Envoie d&rsquo;un email d&rsquo;alerte à l&rsquo;administrateur lorsque le nombre de vouchers disponibles est en dessous du seuil défini, avec :
<ul>
<li>1 lien vers l&rsquo;interface web du pfSense pour générer un nouveau roll.</li>
<li>1 lien pour ouvrir la liste de secours.</li>
<li>1 lien vers la liste courante.</li>
</ul>
</li>
</ul>
<p>Un script serveur attaché à la liste de secours qui implémente ces fonctionnalités :</p>
<ul>
<li>Ajout d&rsquo;un menu permettant de lancer la procédure d&rsquo;ajout de vouchers de secours à la liste courante.</li>
<li>Le chargement de la configuration contenue dans une feuille spécifique du classeur.</li>
<li>La procédure d&rsquo;ajout de vouchers de secours à la liste courante avec demande de confirmation préalable et gestion des erreurs (authentification, ouverture de fichier).</li>
<li>Envoi d&rsquo;un email indiquant le succès ou l&rsquo;échec éventuel de l&rsquo;opération et indiquant le nombre de vouchers de secours restants.</li>
</ul>
<h3 id="coté-client">Coté client</h3>
<p>Un fichier html contenant le formulaire de réservation de vouchers avec :</p>
<ul>
<li>1 champ pour renseigner le nom du ou des destinataires (groupe ou personne).</li>
<li>1 champ pour la date.</li>
<li>1 champ pour le nombre de vouchers à réserver.</li>
<li>Formatage CSS :
<ul>
<li>Mise en page générale.</li>
<li>Indication des champs requis.</li>
</ul>
</li>
<li>Javascript :
<ul>
<li>Validation des données saisies pour éviter les erreurs, avec retour visuel.</li>
<li>Indication de chargement.</li>
<li>Déclenchement du script serveur suite à la validation du formulaire.</li>
</ul>
</li>
</ul>
<p>Un fichier Html d&rsquo;indication de chargement comportant :</p>
<ul>
<li>1 titre</li>
<li>1 gif animé hébergé sur le Google Drive partagé</li>
</ul>
<hr>
<h2 id="utilisation">Utilisation</h2>
<h3 id="par-les-opérateurs">Par les opérateurs</h3>
<p>À l&rsquo;ouverture du Google Sheet partagé contenant la liste des vouchers disponibles, un script est automatiquement exécuté. Il ajoute une entrée de menu et affiche le formulaire permettant de saisir les informations nécessaires à la réservation de vouchers :</p>
<ul>
<li>Un nom de groupe ou personne.</li>
<li>La date de début de formation.</li>
<li>Le nombre de vouchers à réserver.</li>
</ul>
<p>L&rsquo;opérateur étant connecté pour avoir accès au document, son adresse email est automatiquement récupérée par le script.</p>
<p>Une fois le formulaire correctement renseigné (les données saisies sont vérifiées) le script déplace le nombre de vouchers réservés dans une autre feuille où sont également renseignés les informations propres à la réservation, puis génère une copie du modèle Google Document en y insérant le nom du groupe, la date et la liste de vouchers réservés.</p>
<p>Une boite de dialogue affichant le lien vers le document généré est alors présentée à l&rsquo;opérateur. En suivant ce lien le document s&rsquo;ouvre dans un nouvel onglet de son navigateur, il peut directement l&rsquo;imprimer ou le modifier au préalable si besoin (par ex. : renseigner la colonne des noms d&rsquo;utilisateurs si connus par l&rsquo;opérateur). Si non remplis avant impression, les utilisateurs devront renseigner leur nom et prénom en regard du voucher utilisé.</p>
<p>Une fois le tableau rempli et récupéré, l&rsquo;opérateur devra reporter ces renseignements dans le tableau des vouchers utilisés. Pour se conformer à la législation, ces données devront être conservées pendant une durée minimum d'1 an.</p>
<h3 id="par-ladministrateur">Par l&rsquo;administrateur</h3>
<p>L&rsquo;administrateur génère un roll initial de 1000 vouchers ayants une durée de validité de 5 jours.</p>
<p>Lorsque le nombre de vouchers disponible atteint le seuil minimal, il reçoit un email d&rsquo;alerte lui indiquant le nombre de vouchers disponibles restant et lui présentant :</p>
<ul>
<li>Un lien vers l&rsquo;interface web du pfSense (adresse ip publique accessible de l&rsquo;extérieur).</li>
<li>Un lien vers le Google Sheet contenant les vouchers de secours pour un ajout rapide.</li>
<li>Un lien vers la liste courante pour vérification.</li>
</ul>
<p>S&rsquo;il décide d&rsquo;activer des vouchers de secours, un menu ou un bouton lui permettent d&rsquo;ajouter 100 vouchers de secours à la liste courante. Il peut répéter l&rsquo;opération jusqu&rsquo;à épuisement de la liste de secours. Un email de confirmation (ou d&rsquo;erreur) lui est automatiquement envoyé à chaque ajout lui indiquant le succès (ou l&rsquo;échec le cas échéant) de l&rsquo;opération ainsi que le nombre de vouchers de secours restants.</p>
<p>Ensuite, lorsque son emploi du temps lui permettra, il devra générer un nouveau roll de vouchers par le biais de l&rsquo;interface web du pfSense et les ajouter à la liste courante. Il devra également s&rsquo;assurer de disposer d&rsquo;un nombre suffisant de vouchers de secours en cas de besoin.</p>
<hr>
<h2 id="mise-en-production">Mise en production</h2>
<p>Le document Google Sheet contenant la liste courante de voucher doit être stocké dans un dossier principal Google Drive (&lsquo;CEFIM_PEDAGO&rsquo;). Ce document doit être partagé nominativement (utiliser le partage &ldquo;Limité&rdquo;) en renseignant une adresse email pour chaque collaborateur devant avoir un accès à cette liste. Ceci est nécessaire pour pouvoir récupérer automatiquement son adresse email via le script. Ce document comportera 3 feuilles de calcul :</p>
<ul>
<li>1 feuille nommée <strong>&ldquo;Vouchers&rdquo;</strong> contenant la liste des vouchers disponibles.</li>
<li>1 feuille nommée <strong>&ldquo;Utilisés&rdquo;</strong> contenant la liste des vouchers réservés.</li>
<li>1 feuille nommée <strong>&ldquo;Config&rdquo;</strong> (masquée) contenant les paramètres des scripts.</li>
</ul>
<p>Le modèle Google Document sera hébergé dans le dossier principal avec la liste courante et pourra être partagé de manière plus permissive (option de partage &ldquo;Tous les utilisateurs qui ont le lien&rdquo;).</p>
<p>Le document Google Sheet contenant les vouchers de secours doit être, quant-à-lui, stocké dans un sous dossier privé (&lsquo;PRIVATE&rsquo;) du dossier principal et n&rsquo;être accessible que par l&rsquo;administrateur en charge de la génération des rolls de vouchers (détenant un accès au pfSense). Il ne comportera qu&rsquo;une seule feuille nommée <strong>&ldquo;Liste_Secours&rdquo;</strong>.</p>
<p><strong>Important : Bien respecter les noms des feuilles de calcul pour les 2 Google Sheet tels qu&rsquo;indiqués ci-dessus en gras : Les scripts s&rsquo;appuient sur ces noms de feuille.</strong></p>
<h3 id="partages">Partages</h3>
<ul>
<li>Dossier principal &lsquo;CEFIM_PEDAGO&rsquo; : Tous les utilisateurs qui ont le lien</li>
<li>Sous-dossier &lsquo;DOCS&rsquo; : Tous les utilisateurs qui ont le lien</li>
<li>Sous-dossier &lsquo;PRIVATE&rsquo; : Non partagé</li>
<li>Google Sheet &lsquo;Vouchers_CEFIM_PEDAGO&rsquo; : Partage limité</li>
<li>Google Document &lsquo;Template_Vouchers_CEFIM_PEAGO&rsquo; : Tous les utilisateurs qui ont le lien</li>
<li>Google Sheet &lsquo;Vouchers_CEFIM_PEDAGO_SECOURS&rsquo; : Non partagé</li>
</ul>
<hr>
<h2 id="améliorations-ultérieures-éventuelles">Améliorations ultérieures éventuelles</h2>
<ul>
<li>
<p>Création et gestions de plusieurs rolls avec des durées de validité différentes (1/2 journée - 1 jour - 2 jours - 3 jours - 4 jours - 1 semaine - 2 semaines - 1 mois) pour correspondre aux durées des différentes formations dispensées. Autant de rolls de secours devront être prévus.</p>
</li>
<li>
<p>Dans le cas où l&rsquo;opérateur renseigne les noms/prénoms des utilisateurs avant impression, disposer d&rsquo;un script attaché au document permettant de reporter automatiquement ces infos dans le tableau des vouchers utilisés.</p>
</li>
<li>
<p>Export des vouchers réservés à l&rsquo;issue de chaque formation afin d&rsquo;en faciliter la vérification (s&rsquo;ils ont été utilisés ou non) ou l&rsquo;invalidation (interface web du pfSense dans les 2 cas).</p>
</li>
</ul>
<hr>
<h2 id="annexes">Annexes</h2>
<h3 id="caractéristiques-des-rolls-de-vouchers">Caractéristiques des rolls de vouchers</h3>
<ul>
<li>Ils comportent un numéro unique parmi les rolls actifs.</li>
<li>On leur affecte un nombre de vouchers (1023 maximum avec le nombre de bits de ticket par défaut).</li>
<li>On leur défini une durée de validité en heures.</li>
<li>Une description leur est associée.</li>
</ul>
<p><strong>Attention : Tout changement dans les champs de nombre de bits (roll, ticket ou somme de contrôle - voir ci-après) invalide immédiatement tout roll créé précédemment.</strong></p>
<h3 id="caractéristiques-générales-des-vouchers-pfsense">Caractéristiques générales des vouchers pfSense</h3>
<blockquote>
<p><em>Le texte en italique ci-dessous est une traduction de la documentation officielle.</em></p>
</blockquote>
<ul>
<li>Clés RSA : <code>64 bits maximum</code> (32 bits par défaut).</li>
<li>Jeu de caractères (utilisé pour la création des vouchers) : <code>2345678abcdefhijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ</code> (par défaut - les caractères pouvant prêter à confusion sont retirés).</li>
</ul>
<p>Bits des vouchers : <em>Les champs de bits suivants contrôlent la manière dont les vouchers sont généré par le portail. Il est recommandé d&rsquo;utiliser les valeurs par défaut mais celles-ci peuvent être ajustées si nécessaire. Le total de tous les champs de bits doit être inférieur au nombre de bits de la clé RSA (exemple avec les valeurs par défaut : 16 + 10 + 5 = 31 =&gt; 32 - 1).</em></p>
<ul>
<li>Bits de roll : [1-31], défaut : <code>16</code> =&gt; définit le nombre maximum de rolls actifs simultanément = 65535 avec 16 bits (2^16 - 1, défaut).</li>
<li>Bits de ticket : [1-16], défaut : <code>10</code> =&gt; définit le nombre maximum de vouchers par roll = 1023 avec 10 bits (2^10 - 1, défaut).</li>
<li>Bits de somme de contrôle : [0-31], défaut : <code>5</code> =&gt; bits de contrôle d&rsquo;intégrité.</li>
</ul>
<p><em>Le &rsquo;nombre magique&rsquo; est présent dans chaque voucher et est vérifié par le portail lors de la vérification du voucher. La taille du nombre magique dépend du nombre de bits restant après avoir additionné les bits de roll, voucher et somme de contrôle. S&rsquo;il ne reste aucun bit disponible, le nombre magique n&rsquo;est pas utilisé.</em></p>
<p>Les deux derniers champs de la page de configuration permettent de personnaliser les messages d&rsquo;erreur en cas de tentative de connexion avec un code invalide ou avec un code expiré.</p>
<p>En résumé : Pour augmenter le nombre maximum de vouchers générés par roll il faut augmenter le nombre de bits de ticket tout en diminuant d&rsquo;autant le nombre de bits de roll (en conséquence les vouchers générés comporteront davantage de caractères).</p>
<h3 id="caractéristiques-des-vouchers-pour-cefim_pedago">Caractéristiques des vouchers pour CEFIM_PEDAGO</h3>
<ul>
<li>Générés par roll de 1000 vouchers.</li>
<li>Durée de validité de 5 jours à compter du moment d&rsquo;activation par l&rsquo;utilisateur.</li>
</ul>
<p>Les options suivantes conservent les valeurs par défaut :</p>
<ul>
<li>Clés RSA de 32 Bit (Public/Private).</li>
<li>Jeu de caractères : 2345678abcdefhijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ</li>
<li>Bits de roll : 16</li>
<li>Bits de tickets : 10</li>
<li>Bits de somme de contrôle : 5</li>
<li>Nombre magique à 10 chiffres.</li>
</ul>
<hr>
<h3 id="captures-décrans">Captures d&rsquo;écrans</h3>
<ul>
<li>Le formulaire de réservation :</li>
</ul>
<p>
<a href="#image-544b9aceff651535f2faecbf5cfb540b" class="lightbox-link">
<img src="../at2/at2e2/stage-cefim/01-Furmulaire%20r%C3%A9servation.png" alt="Formulaire de réservation" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-544b9aceff651535f2faecbf5cfb540b">
<img src="../at2/at2e2/stage-cefim/01-Furmulaire%20r%C3%A9servation.png" alt="Formulaire de réservation" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Le modèle de document :</li>
</ul>
<p>
<a href="#image-34b4e643527073c9befc241efa6744b4" class="lightbox-link">
<img src="../at2/at2e2/stage-cefim/02-Template%20Vouchers%20CEFIM_PEDAGO.png" alt="Modèle de document" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-34b4e643527073c9befc241efa6744b4">
<img src="../at2/at2e2/stage-cefim/02-Template%20Vouchers%20CEFIM_PEDAGO.png" alt="Modèle de document" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>La présentation du lien vers le document généré :</li>
</ul>
<p>
<a href="#image-19c4b0deffaf475fe260ccd77767b86a" class="lightbox-link">
<img src="../at2/at2e2/stage-cefim/03-Lien%20document%20g%C3%A9n%C3%A9r%C3%A9.png" alt="Lien document généré" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-19c4b0deffaf475fe260ccd77767b86a">
<img src="../at2/at2e2/stage-cefim/03-Lien%20document%20g%C3%A9n%C3%A9r%C3%A9.png" alt="Lien document généré" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Le document généré :</li>
</ul>
<p>
<a href="#image-17599af739bc01494108015f9bf074fd" class="lightbox-link">
<img src="../at2/at2e2/stage-cefim/04-Document%20g%C3%A9n%C3%A9r%C3%A9.png" alt="Document généré" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-17599af739bc01494108015f9bf074fd">
<img src="../at2/at2e2/stage-cefim/04-Document%20g%C3%A9n%C3%A9r%C3%A9.png" alt="Document généré" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Le document généré modifié :</li>
</ul>
<p>
<a href="#image-1c8df9954ee1cd68acb459df2553c42e" class="lightbox-link">
<img src="../at2/at2e2/stage-cefim/05-Document%20g%C3%A9n%C3%A9r%C3%A9%20modifi%C3%A9.png" alt="Document généré modifié" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-1c8df9954ee1cd68acb459df2553c42e">
<img src="../at2/at2e2/stage-cefim/05-Document%20g%C3%A9n%C3%A9r%C3%A9%20modifi%C3%A9.png" alt="Document généré modifié" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>L&rsquo;email d&rsquo;alerte de liste épuisée :</li>
</ul>
<p>
<a href="#image-08fc36adbb6c420a43cc56840199470c" class="lightbox-link">
<img src="../at2/at2e2/stage-cefim/06-email%20alete%20liste%20%C3%A9puis%C3%A9e.png" alt="Email alerte liste épuisée" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-08fc36adbb6c420a43cc56840199470c">
<img src="../at2/at2e2/stage-cefim/06-email%20alete%20liste%20%C3%A9puis%C3%A9e.png" alt="Email alerte liste épuisée" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>L&rsquo;email de confirmation d&rsquo;activation de vouchers de secours :</li>
</ul>
<p>
<a href="#image-d9db75103bd7f023f8e46dc4b6797999" class="lightbox-link">
<img src="../at2/at2e2/stage-cefim/07-email%20confirm%20secours.png" alt="Email confirmation secours" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d9db75103bd7f023f8e46dc4b6797999">
<img src="../at2/at2e2/stage-cefim/07-email%20confirm%20secours.png" alt="Email confirmation secours" class="lightbox-image" loading="lazy">
</a></p>
<hr>
<h3 id="code">Code</h3>
<p>Vouchers CEFIM_PEDAGO</p>
<p>Code.gs :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Global config object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Add a menu entry to UI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">onOpen</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getUi</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">createMenu</span><span class="p">(</span><span class="s1">&#39;🔑VOUCHERS&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">addItem</span><span class="p">(</span><span class="s1">&#39;Reserver&#39;</span><span class="p">,</span> <span class="s1">&#39;openFormDialog&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">addToUi</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Open the form dialog (triggered by opening the spreadsheet or by the VOUCHERS menu)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">openFormDialog</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">sheet</span> <span class="o">=</span> <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActive</span><span class="p">().</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="s1">&#39;Vouchers&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sheet</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">HtmlService</span><span class="p">.</span><span class="nx">createHtmlOutputFromFile</span><span class="p">(</span><span class="s1">&#39;Form&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">setWidth</span><span class="p">(</span><span class="mi">520</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">setHeight</span><span class="p">(</span><span class="mi">320</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getUi</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">showModalDialog</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="s1">&#39;Vouchers CEFIM_PEDAGO&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Show the loading dialog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">openLoadingModal</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">HtmlService</span><span class="p">.</span><span class="nx">createHtmlOutputFromFile</span><span class="p">(</span><span class="s1">&#39;Loading&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">setWidth</span><span class="p">(</span><span class="mi">520</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">setHeight</span><span class="p">(</span><span class="mi">360</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getUi</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">showModalDialog</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="s1">&#39;Chargement...&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Populate the config object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">getConfig</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">configSheet</span> <span class="o">=</span> <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActive</span><span class="p">().</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="s1">&#39;Config&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">config</span><span class="p">.</span><span class="nx">templateId</span> <span class="o">=</span> <span class="nx">configSheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">config</span><span class="p">.</span><span class="nx">docFolderId</span> <span class="o">=</span> <span class="nx">configSheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">config</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">configSheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">config</span><span class="p">.</span><span class="nx">lowlimit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">configSheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">getValue</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`*CONFIG* templateId: </span><span class="si">${</span><span class="nx">config</span><span class="p">.</span><span class="nx">templateId</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        docFolderId: </span><span class="si">${</span><span class="nx">config</span><span class="p">.</span><span class="nx">docFolderId</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        email: </span><span class="si">${</span><span class="nx">config</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        lowlimit: </span><span class="si">${</span><span class="nx">config</span><span class="p">.</span><span class="nx">lowLimit</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create a Google Document with form response data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">createDocumentFromFormData</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">config</span> <span class="o">=</span> <span class="nx">getConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">ui</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Form response (or test data if debugging)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">grp</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">group</span> <span class="o">?</span> <span class="nx">form</span><span class="p">.</span><span class="nx">group</span> <span class="o">:</span> <span class="s1">&#39;DEBUG TEST GRP [&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">date</span> <span class="o">?</span> <span class="nx">form</span><span class="p">.</span><span class="nx">date</span> <span class="o">:</span> <span class="s1">&#39;2022-12-31&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">nb</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">nb</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">nb</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Localized date
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">fdate</span> <span class="o">=</span> <span class="nx">Utilities</span><span class="p">.</span><span class="nx">formatDate</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">),</span> <span class="s1">&#39;Europe/Paris&#39;</span><span class="p">,</span> <span class="s1">&#39;dd/MM/yyyy&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Get email of the user executing the script
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">getActiveUser</span><span class="p">().</span><span class="nx">getEmail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActive</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Store the working Sheets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">vlist</span> <span class="o">=</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="s1">&#39;Vouchers&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">used</span> <span class="o">=</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="s1">&#39;Utilisés&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">vlist</span><span class="p">.</span><span class="nx">getDataRange</span><span class="p">().</span><span class="nx">getValues</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Make a copy of the template Document &amp; store its ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">documentId</span> <span class="o">=</span> <span class="nx">DriveApp</span><span class="p">.</span><span class="nx">getFileById</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">templateId</span><span class="p">).</span><span class="nx">makeCopy</span><span class="p">().</span><span class="nx">getId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Using string interpolation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">title</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">date</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="nx">grp</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">docFile</span> <span class="o">=</span> <span class="nx">DriveApp</span><span class="p">.</span><span class="nx">getFileById</span><span class="p">(</span><span class="nx">documentId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">docFile</span><span class="p">.</span><span class="nx">setName</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Add the docFile to the doc sub-folder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">DriveApp</span><span class="p">.</span><span class="nx">getFolderById</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">docFolderId</span><span class="p">).</span><span class="nx">addFile</span><span class="p">(</span><span class="nx">docFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Remove the docFile ref from the current folder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">docFile</span><span class="p">.</span><span class="nx">getParents</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">removeFile</span><span class="p">(</span><span class="nx">docFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">documentUrl</span> <span class="o">=</span> <span class="sb">`https://docs.google.com/document/d/</span><span class="si">${</span><span class="nx">documentId</span><span class="si">}</span><span class="sb">/edit`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">docBody</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">openById</span><span class="p">(</span><span class="nx">documentId</span><span class="p">).</span><span class="nx">getBody</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">docBody</span><span class="p">.</span><span class="nx">replaceText</span><span class="p">(</span><span class="s1">&#39;##Groupe##&#39;</span><span class="p">,</span> <span class="nx">grp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">docBody</span><span class="p">.</span><span class="nx">replaceText</span><span class="p">(</span><span class="s1">&#39;##Date##&#39;</span><span class="p">,</span> <span class="nx">fdate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">placeholder</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Store the 1st empty row from the used Sheet before insertion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">firstRow</span> <span class="o">=</span> <span class="nx">used</span><span class="p">.</span><span class="nx">getLastRow</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Get &amp; move the needed number of Vouchers from the vlist Sheet to the used Sheet,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// starting from the end of the list (one by one to timestamp each of them)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">row</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">nb</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">row</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vlist</span><span class="p">.</span><span class="nx">deleteRow</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">placeholder</span> <span class="o">=</span> <span class="sb">`##voucher</span><span class="si">${</span><span class="nx">j</span><span class="si">}</span><span class="sb">##`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// row[0] is the voucher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">docBody</span><span class="p">.</span><span class="nx">replaceText</span><span class="p">(</span><span class="nx">placeholder</span><span class="p">,</span> <span class="nx">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// add the timestamp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Utilities</span><span class="p">.</span><span class="nx">formatDate</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="s1">&#39;Europe/Paris&#39;</span><span class="p">,</span> <span class="s1">&#39;yyyy/MM/dd  HH:mm:ss.SSS&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Following data need to be written 1 time only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fdate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nx">grp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nx">documentUrl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Append the row to the used list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">used</span><span class="p">.</span><span class="nx">appendRow</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Count remaining vouchers en send an alert if &lt;= config.lowlimit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">rows</span> <span class="o">=</span> <span class="nx">vlist</span><span class="p">.</span><span class="nx">getDataRange</span><span class="p">().</span><span class="nx">getValues</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">vouchersLeft</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">vouchersLeft</span> <span class="o">&lt;=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">lowlimit</span><span class="p">)</span> <span class="p">{</span><span class="nx">sendAlertEmail</span><span class="p">(</span><span class="nx">vouchersLeft</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Format inserted data inside the used Sheet (merge - valign - borders - columns auto resize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">lastRow</span> <span class="o">=</span> <span class="nx">used</span><span class="p">.</span><span class="nx">getLastRow</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">range</span> <span class="o">=</span> <span class="sb">`D</span><span class="si">${</span><span class="nx">firstRow</span><span class="si">}</span><span class="sb">:G</span><span class="si">${</span><span class="nx">lastRow</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// merge &amp; align
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">used</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">range</span><span class="p">).</span><span class="nx">mergeVertically</span><span class="p">().</span><span class="nx">setVerticalAlignment</span><span class="p">(</span><span class="s1">&#39;middle&#39;</span><span class="p">).</span><span class="nx">setHorizontalAlignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">range</span> <span class="o">=</span> <span class="sb">`A</span><span class="si">${</span><span class="nx">firstRow</span><span class="si">}</span><span class="sb">:G</span><span class="si">${</span><span class="nx">lastRow</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// borders
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">used</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">range</span><span class="p">).</span><span class="nx">setBorder</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// autoresize colums
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">used</span><span class="p">.</span><span class="nx">autoResizeColumns</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Delete unused placeholders in the Document
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">placeholder</span> <span class="o">=</span> <span class="sb">`##voucher</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">##`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">docBody</span><span class="p">.</span><span class="nx">replaceText</span><span class="p">(</span><span class="nx">placeholder</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">search</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">tables</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Extract all the tables inside the Document
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="nx">search</span> <span class="o">=</span> <span class="nx">docBody</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">ElementType</span><span class="p">.</span><span class="nx">TABLE</span><span class="p">,</span> <span class="nx">search</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tables</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">search</span><span class="p">.</span><span class="nx">getElement</span><span class="p">().</span><span class="nx">asTable</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Delete all empty rows from the Document tables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">tables</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">trows</span> <span class="o">=</span> <span class="nx">table</span><span class="p">.</span><span class="nx">getNumRows</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Iterate through each row of the table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">trows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">r</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// If the table row contains no text, delete it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="nx">table</span><span class="p">.</span><span class="nx">getRow</span><span class="p">(</span><span class="nx">r</span><span class="p">).</span><span class="nx">getText</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nx">table</span><span class="p">.</span><span class="nx">removeRow</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Show the ready to print Document link in a modal dialog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActive</span><span class="p">().</span><span class="nx">toast</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">nb</span><span class="si">}</span><span class="sb"> vouchers réservés pour le groupe </span><span class="si">${</span><span class="nx">grp</span><span class="si">}</span><span class="sb"> pour le </span><span class="si">${</span><span class="nx">fdate</span><span class="si">}</span><span class="sb"> par </span><span class="si">${</span><span class="nx">user</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;html&gt;&lt;head&gt;&lt;style&gt;* {font-family: &#34;Google Sans&#34;,Roboto,RobotoDraft,Helvetica,Arial,sans-serif;}&lt;/style&gt;&lt;/head&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;body&gt;&lt;h1&gt;&lt;a href=&#34;&#39;</span> <span class="o">+</span> <span class="nx">documentUrl</span> <span class="o">+</span> <span class="s1">&#39;&#34; target=&#34;_blank&#34;&gt;Ouvrir le document&lt;/a&gt;&lt;/h1&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;h3&gt;Une fois ouvert, le document peut être modifié et/ou imprimé.&lt;/h3&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;p&gt;Le lien du document est également accessible via la feuille &#34;Utilisés&#34;.&lt;/p&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;div style=&#34;margin: 80px auto auto 200px;&#34;&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;input type=&#34;button&#34; value=&#34;Fermer&#34; id=&#34;btnclose&#34; onclick=&#34;google.script.host.close();&#34; style=&#34; width: 80px; height: 30px;&#34; /&gt;&lt;/div&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ui</span> <span class="o">=</span> <span class="nx">HtmlService</span><span class="p">.</span><span class="nx">createHtmlOutput</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getUi</span><span class="p">().</span><span class="nx">showModalDialog</span><span class="p">(</span><span class="nx">ui</span><span class="p">,</span> <span class="nx">title</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">sendAlertEmail</span><span class="p">(</span><span class="nx">nbleft</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`sendAlertEmail a démarré avec le paramètre nbleft=</span><span class="si">${</span><span class="nx">nbleft</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">subject</span> <span class="o">=</span> <span class="s1">&#39;Alerte CEFIM_PEDAGO Vouchers : Liste épuisée&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&lt;html&gt;&lt;body&gt;&lt;h1 style=&#34;color: red;&#34;&gt;La liste de vouchers CEFIM_PEDAGO disponibles arrive à épuisement.&lt;/h1&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;h2&gt;Il reste &lt;b&gt;&#39;</span> <span class="o">+</span> <span class="nx">nbleft</span> <span class="o">+</span> <span class="s1">&#39; vouchers disponibles&lt;/b&gt; dans la liste courante.&lt;/h2&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;h3&gt;&lt;p&gt;Options :&lt;/p&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;ul&gt;&lt;li&gt;&lt;a href=&#34;https://46.247.250.13:666//&#34; target=&#34;_blank&#34;&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;Se connecter à l\&#39;inteface web du pfSense CEFIM_PEDAGO afin de générer un nouveau Roll&lt;/a&gt;&lt;/li&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&#34;https://docs.google.com/spreadsheets/d/12vdKWwv6jeDFzN9X8V79do9gQrcitEgQPXLvzj6H91w&#34; target=&#34;_blank&#34;&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;Ouvrir la liste de secours pour ajout rapide de vouchers&lt;/a&gt;&lt;/li&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&#34;https://docs.google.com/spreadsheets/d/16eqNvG-Z5y9pHuQbCb80A3K3q3gIcX9S6Ja_7TwtFZ0/edit#gid=1505767989&#34; target=&#34;_blank&#34;&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="s1">&#39;Ouvrir la liste régulière pour vérifications&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">MailApp</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">to</span><span class="o">:</span><span class="nx">config</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">subject</span><span class="o">:</span><span class="nx">subject</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">htmlBody</span><span class="o">:</span><span class="nx">body</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span><span class="s1">&#39;CEFIM_PEDAGO - Vouchers alerte&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Form.html :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">base</span> <span class="nx">target</span><span class="o">=</span><span class="s2">&#34;_top&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span> <span class="p">{</span><span class="nx">font</span><span class="o">-</span><span class="nx">family</span><span class="o">:</span> <span class="s2">&#34;Google Sans&#34;</span><span class="p">,</span><span class="nx">Roboto</span><span class="p">,</span><span class="nx">RobotoDraft</span><span class="p">,</span><span class="nx">Helvetica</span><span class="p">,</span><span class="nx">Arial</span><span class="p">,</span><span class="nx">sans</span><span class="o">-</span><span class="nx">serif</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span><span class="nx">info</span> <span class="p">{</span><span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="o">:</span> <span class="mi">14</span><span class="nx">px</span><span class="p">;</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">red</span><span class="p">;</span> <span class="nx">margin</span><span class="o">-</span><span class="nx">bottom</span><span class="o">:</span> <span class="mi">10</span><span class="nx">px</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">p</span> <span class="p">{</span><span class="nx">font</span><span class="o">-</span><span class="nx">weight</span><span class="o">:</span> <span class="mi">600</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">label</span> <span class="p">{</span><span class="nx">display</span><span class="o">:</span> <span class="nx">inline</span><span class="o">-</span><span class="nx">block</span><span class="p">;</span> <span class="nx">width</span><span class="o">:</span> <span class="mi">210</span><span class="nx">px</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">label</span><span class="o">::</span><span class="nx">after</span> <span class="p">{</span><span class="nx">content</span><span class="o">:</span> <span class="s2">&#34; *&#34;</span><span class="p">;</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">red</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">input</span> <span class="p">{</span><span class="nx">display</span><span class="o">:</span> <span class="nx">inline</span><span class="o">-</span><span class="nx">block</span><span class="p">;</span> <span class="nx">width</span><span class="o">:</span> <span class="mi">260</span><span class="nx">px</span><span class="p">;</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">blue</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span><span class="nx">date</span> <span class="p">{</span><span class="nx">width</span><span class="o">:</span> <span class="mi">120</span><span class="nx">px</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span><span class="nx">nb</span> <span class="p">{</span><span class="nx">width</span><span class="o">:</span> <span class="mi">40</span><span class="nx">px</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">sep</span> <span class="p">{</span><span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="o">:</span> <span class="mi">10</span><span class="nx">px</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">msg</span> <span class="p">{</span><span class="nx">display</span><span class="o">:</span> <span class="nx">none</span><span class="p">;</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">red</span><span class="p">;</span> <span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="o">:</span> <span class="mi">10</span><span class="nx">px</span><span class="p">;</span> <span class="nx">margin</span><span class="o">-</span><span class="nx">left</span><span class="o">:</span> <span class="mi">110</span><span class="nx">px</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span><span class="nx">btnsubmit</span><span class="p">,</span> <span class="err">#</span><span class="nx">btncancel</span> <span class="p">{</span><span class="nx">width</span><span class="o">:</span> <span class="mi">210</span><span class="nx">px</span><span class="p">;</span> <span class="nx">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">12</span><span class="nx">px</span> <span class="mi">0</span> <span class="mi">12</span><span class="nx">px</span><span class="p">;</span> <span class="nx">padding</span><span class="o">:</span> <span class="mi">5</span><span class="nx">px</span> <span class="mi">0</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span><span class="nx">loading</span> <span class="p">{</span><span class="nx">display</span><span class="o">:</span> <span class="nx">none</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span><span class="nx">loadtxt</span> <span class="p">{</span><span class="nx">position</span><span class="o">:</span> <span class="nx">absolute</span><span class="p">;</span> <span class="nx">top</span><span class="o">:</span> <span class="mi">2</span><span class="nx">px</span><span class="p">;</span> <span class="nx">left</span><span class="o">:</span> <span class="mi">2</span><span class="nx">px</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span><span class="nx">loadimg</span> <span class="p">{</span><span class="nx">position</span><span class="o">:</span> <span class="nx">relative</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/style&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/head&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;form&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Les</span> <span class="nx">vouchers</span> <span class="nx">CEFIM_PEDAGO</span> <span class="nx">sont</span> <span class="nx">valides</span> <span class="mi">5</span> <span class="nx">jours</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">hr</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;info&#34;</span><span class="o">&gt;*</span> <span class="nx">Requis</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;resaForm&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;grp&#34;</span><span class="o">&gt;</span><span class="nx">Nom</span> <span class="nx">ou</span> <span class="nx">Groupe</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;grp&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;group&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;badgrp&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;msg&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Indiquer</span> <span class="nx">un</span> <span class="nx">nom</span> <span class="nx">de</span> <span class="nx">personne</span> <span class="nx">ou</span> <span class="nx">de</span> <span class="nx">groupe</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;sepgrp&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;sep&#34;</span><span class="o">&gt;&lt;</span><span class="nx">p</span><span class="o">&gt;&amp;</span><span class="nx">nbsp</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/p&gt;&lt;/div&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;date&#34;</span><span class="o">&gt;</span><span class="nb">Date</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;date&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;date&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;date&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;baddate&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;msg&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Choisir</span> <span class="nx">une</span> <span class="nx">date</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;sepdate&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;sep&#34;</span><span class="o">&gt;&lt;</span><span class="nx">p</span><span class="o">&gt;&amp;</span><span class="nx">nbsp</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/p&gt;&lt;/div&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;nb&#34;</span><span class="o">&gt;</span><span class="nx">Nombre</span> <span class="nx">de</span> <span class="nx">vouchers</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">25</span><span class="p">)</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;number&#34;</span> <span class="nx">min</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="nx">max</span><span class="o">=</span><span class="s2">&#34;25&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;nb&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;nb&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;badnb&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;msg&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Choisir</span> <span class="nx">un</span> <span class="nx">nombre</span> <span class="nx">entre</span> <span class="mi">1</span> <span class="nx">et</span> <span class="mi">25</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;sepnb&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;sep&#34;</span><span class="o">&gt;&lt;</span><span class="nx">p</span><span class="o">&gt;&amp;</span><span class="nx">nbsp</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/p&gt;&lt;/div&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">hr</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;button&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;Annuler&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;btncancel&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">onclick</span><span class="o">=</span><span class="s2">&#34;google.script.host.close();&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;button&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;Valider&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;btnsubmit&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">onclick</span><span class="o">=</span><span class="s2">&#34;submitForm();&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="err">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;grp&#34;</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Called right after the form is submited
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">function</span> <span class="nx">submitForm</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">grp</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;grp&#34;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">grp</span> <span class="o">===</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;badgrp&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;sepgrp&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">err</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;badgrp&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;sepgrp&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">dat</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">dat</span> <span class="o">===</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;baddate&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;sepdate&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">err</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;baddate&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;sepdate&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">num</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;nb&#34;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="nx">num</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">num</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;badnb&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;sepnb&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">err</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;badnb&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;sepnb&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">google</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">run</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="nx">openLoadingModal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">google</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">run</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="nx">withSuccessHandler</span><span class="p">(</span><span class="nx">onSubmitSuccess</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="nx">createDocumentFromFormData</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;resaForm&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Called when the form is successfully submited - google.script.run is asynchronous
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">function</span> <span class="nx">onSubmitSuccess</span><span class="p">(</span><span class="cm">/*serverFunctionOutput, userObj*/</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">google</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">run</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="nx">withSuccessHandler</span><span class="p">(</span><span class="nx">onLoadSuccess</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="nx">openLoadingModal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Called when the process is finished
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">function</span> <span class="nx">onLoadSuccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">google</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/body&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></span></code></pre></div><p>Loading.html :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">base</span> <span class="nx">target</span><span class="o">=</span><span class="s2">&#34;_top&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span> <span class="p">{</span><span class="nx">font</span><span class="o">-</span><span class="nx">family</span><span class="o">:</span> <span class="s2">&#34;Google Sans&#34;</span><span class="p">,</span><span class="nx">Roboto</span><span class="p">,</span><span class="nx">RobotoDraft</span><span class="p">,</span><span class="nx">Helvetica</span><span class="p">,</span><span class="nx">Arial</span><span class="p">,</span><span class="nx">sans</span><span class="o">-</span><span class="nx">serif</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">img</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">display</span><span class="o">:</span> <span class="nx">block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">margin</span><span class="o">-</span><span class="nx">left</span><span class="o">:</span> <span class="nx">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">margin</span><span class="o">-</span><span class="nx">right</span><span class="o">:</span> <span class="nx">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">width</span><span class="o">:</span> <span class="mi">90</span><span class="o">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">h2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">position</span><span class="o">:</span> <span class="nx">absolute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">top</span><span class="o">:</span> <span class="mi">2</span><span class="nx">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">left</span><span class="o">:</span> <span class="mi">50</span><span class="nx">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/style&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/head&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;loading&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;loadimg&#34;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://lh3.googleusercontent.com/M7YzZMHlX9FO4tQC_o3FbCHXzA1GpYKSmP1h-w0EeGR40CNppuVzEkNZio8lRI9ZwLM=w2400&#34;</span> <span class="nx">title</span><span class="o">=</span><span class="s2">&#34;Loading...&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">h2</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;loadtxt&#34;</span><span class="o">&gt;</span><span class="nx">Patientez</span> <span class="nx">svp</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/body&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></span></code></pre></div>
            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="chapter">
<div class="article-subheading">Chapitre 3</div>
<h1 id="maintenir-et-exploiter-un-serveur-linux">Maintenir et exploiter un serveur Linux</h1>

<hr>
<h4 id="1-serveur-lampsat2at2e3lamps">1. <a href="../at2/at2e3/lamps/">Serveur LAMPS</a></h4>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Sous-sections de Maintenir et exploiter un serveur Linux</h1>
          <article class="chapter">
<div class="article-subheading">Exemple 3</div>
<h1 id="serveur-lamps">Serveur LAMPS</h1>

<h2 id="serveur-lamps-avec-mediawiki">Serveur LAMPS avec MediaWiki</h2>
<p>
<a href="#image-0bfcd1182d25f4894acb6a44ccdca52f" class="lightbox-link">
<img src="../at2/at2e3/lamps/0_1_architecture.png" alt="Architecture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-0bfcd1182d25f4894acb6a44ccdca52f">
<img src="../at2/at2e3/lamps/0_1_architecture.png" alt="Architecture" class="lightbox-image" loading="lazy">
</a>
<em>Ici, nous installerons MediaWiki en lieu et place de Wordpress</em></p>
<h2 id="1---préambule">1 - Préambule</h2>
<p><a href="https://files.fosswire.com/2007/08/fwunixref.pdf" target="_blank">cheat sheet linux</a></p>
<p>Avoir une machine debian 11 en ip fixe avec :</p>
<ul>
<li>une connexion ssh</li>
<li>.bashrc configuré</li>
<li>(ssh) nmap zip dnsutils net-tools tzdata lynx sudo curl git screen locate ncdu</li>
<li>la dernière version de webmin (finir l&rsquo;installation avec apt -f install)</li>
<li>winbind samba</li>
</ul>
<p>Configurer :</p>
<ul>
<li>resolv.conf</li>
<li>hosts</li>
<li>hostname</li>
<li>nsswitch</li>
<li>timezone (dpkg-reconfigure tzdata)</li>
</ul>
<p><em>Sur Windows</em> : ajouter AdresseIp[TAB]fqdn dans le fichier <code>C:\Windows\System32\drivers\etc\hosts</code> de Windows <strong>en Administrateur</strong></p>
<p>dans mon cas :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">92.168.0.200  wiki.infra.lan
</span></span></code></pre></div>
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Attention</div>
  <div class="box-content">
<p><em><strong>Choisir des mots de passe forts si utilisation en production.</strong></em></p>
  </div>
</div>
<h2 id="2---apache-2">2 - APACHE 2</h2>
<h3 id="installation-et-configuration-dapache-24">installation et configuration d&rsquo;apache 2.4</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install apache2
</span></span></code></pre></div><ul>
<li>activation du module SSL</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">a2enmod ssl
</span></span></code></pre></div><ul>
<li>activation du site SSL</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">a2ensite default-ssl
</span></span></code></pre></div><ul>
<li>relancer le service (systemctl restart apache2)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><h3 id="--génération-du-certificat-auto-signé-pour-10-ans">- génération du certificat auto signé pour 10 ans</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openssl req <span class="nv">$@</span> -new -x509 -days <span class="m">3650</span> -nodes -out /etc/apache2/apache.pem -keyout /etc/apache2/apache.pem
</span></span></code></pre></div><p>
<a href="#image-7f05abc9d0da4179f4ada9d398fda770" class="lightbox-link">
<img src="../at2/at2e3/lamps/2_1_apache_pem.PNG" alt="capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-7f05abc9d0da4179f4ada9d398fda770">
<img src="../at2/at2e3/lamps/2_1_apache_pem.PNG" alt="capture" class="lightbox-image" loading="lazy">
</a></p>
<h3 id="--activation-des-modules-populaires">- activation des modules populaires</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">a2enmod rewrite
</span></span><span class="line"><span class="cl">a2enmod headers
</span></span></code></pre></div><h3 id="--écriture-du-nouveau-certificat-ssl-dans-la-conf-apache-et-changement-du-documentroot-et-redirection">- écriture du nouveau certificat ssl dans la conf apache et changement du documentroot et redirection</h3>
<p>
<a href="#image-85bbfa83af22cc47ad48c8d0882d038c" class="lightbox-link">
<img src="../at2/at2e3/lamps/2_2_apache_default-ssl.conf.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-85bbfa83af22cc47ad48c8d0882d038c">
<img src="../at2/at2e3/lamps/2_2_apache_default-ssl.conf.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /etc/apache2/sites-available/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano default-ssl.conf
</span></span></code></pre></div><h3 id="--nettoyage-et-redirection">- nettoyage et redirection</h3>
<p>(pour une meilleure lisibilité, on peut retirer les commentaires de 000-default.conf et default-ssl.conf)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /etc/apache2/sites-available/000-default.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;VirtualHost *:80&gt;  
</span></span><span class="line"><span class="cl">	Redirect Permanent / https://wiki.infra.lan  
</span></span><span class="line"><span class="cl">&lt;/VirtualHost&gt;
</span></span></code></pre></div><p>
<a href="#image-c06c6fd3caf93842a1f18c411ce4b4b0" class="lightbox-link">
<img src="../at2/at2e3/lamps/2_3_apache_000-default.conf.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c06c6fd3caf93842a1f18c411ce4b4b0">
<img src="../at2/at2e3/lamps/2_3_apache_000-default.conf.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>redémarrer le serveur apache</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><ul>
<li>commenter la section &lt;Directory /var/www/html&gt;&hellip;</Directory> de apache2.conf</li>
</ul>
<pre tabindex="0"><code>nano /etc/apache2/apache2.conf
</code></pre><p>
<a href="#image-06d782b043ee096860237d5d0e768dd8" class="lightbox-link">
<img src="../at2/at2e3/lamps/2_4_apache_apache2.conf.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-06d782b043ee096860237d5d0e768dd8">
<img src="../at2/at2e3/lamps/2_4_apache_apache2.conf.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>
<p>création en mode user du dossier wiki et d’un index dans /home/user/</p>
</li>
<li>
<p>débrayage temporaire en mode user pour la création</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">su user
</span></span><span class="line"><span class="cl">mkdir /home/user/wiki
</span></span></code></pre></div><ul>
<li>créer du contenu dans index.html</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /home/user/wiki/index.html
</span></span></code></pre></div><ul>
<li>repasser en root</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">su -
</span></span></code></pre></div><p>ou</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span></code></pre></div><h3 id="--changement-récursif-de-propriétaire-et-cest-apache-le-nouveau-proprio">- changement récursif de propriétaire et c&rsquo;est apache le nouveau proprio</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chown -R www-data:www-data /home/user/wiki
</span></span></code></pre></div><ul>
<li>ajout de user au groupe www-data</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">usermod -aG www-data user
</span></span></code></pre></div><ul>
<li>changement récursif des droits pour le dossier wiki pour ftp et samba</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod -R <span class="m">775</span> /home/user/wiki
</span></span></code></pre></div><p>
<a href="#image-0a6c8c59cbaf199a1b3a6eb1dc0b62aa" class="lightbox-link">
<img src="../at2/at2e3/lamps/2_5_apache_chown.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-0a6c8c59cbaf199a1b3a6eb1dc0b62aa">
<img src="../at2/at2e3/lamps/2_5_apache_chown.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><h3 id="--fusion-des-2-fichiers-de-conf">- fusion des 2 fichiers de conf</h3>
<ul>
<li>copier le contenu des 2 fichiers de conf (000 et default ssl) dans un seul fichier dans sites-available nommé site.conf</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /etc/apache2/sites-available
</span></span><span class="line"><span class="cl">cat 000-default.conf &gt; site.conf
</span></span><span class="line"><span class="cl">cat default-ssl.conf &gt;&gt; site.conf
</span></span></code></pre></div><ul>
<li>désactivation des 2 fichiers de conf qui ne vont plus servir</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">a2dissite 000-default
</span></span><span class="line"><span class="cl">a2dissite default-ssl
</span></span></code></pre></div><ul>
<li>effacement de ces 2 fichiers</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">rm 000-default.conf
</span></span><span class="line"><span class="cl">rm default-ssl.conf
</span></span></code></pre></div><ul>
<li>activation de la nouvelle et unique conf</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">a2ensite site.conf
</span></span></code></pre></div><ul>
<li>ajout de la section &lt;Directory&hellip; </Directory> dans site.conf qui doit maintenant ressembler à ça :</li>
</ul>
<p>
<a href="#image-f02608cc252ded78246782da7900714b" class="lightbox-link">
<img src="../at2/at2e3/lamps/2_6_apache_site.conf.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f02608cc252ded78246782da7900714b">
<img src="../at2/at2e3/lamps/2_6_apache_site.conf.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><p><strong>à ce stade la page html doit s&rsquo;afficher dans le navigateur de Windows à l&rsquo;adresse <a href="https://wiki.infra.lan" target="_blank">https://wiki.infra.lan</a></strong></p>
<p>
<a href="#image-aa7f21ff2617856ef28cfa81dbf38a1a" class="lightbox-link">
<img src="../at2/at2e3/lamps/2_7_apache_nav.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-aa7f21ff2617856ef28cfa81dbf38a1a">
<img src="../at2/at2e3/lamps/2_7_apache_nav.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<h2 id="3---mysql">3 - MySQL</h2>
<h3 id="installation-et-configuration-de-mysql">Installation et configuration de MySQL</h3>
<ul>
<li>installation de mysql8 en lieu et place de maria</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://repo.mysql.com/mysql-apt-config_0.8.23-1_all.deb
</span></span><span class="line"><span class="cl">dpkg -i mysql-apt-config_0.8.23-1_all.deb
</span></span></code></pre></div><blockquote>
<p>Sélectionner &lsquo;MySQL Server &amp; Cluster&hellip;&rsquo; + [entrée]</p>
</blockquote>
<p>
<a href="#image-8e3d1c5e668c98157ddd1b206e351bd9" class="lightbox-link">
<img src="../at2/at2e3/lamps/3_1_mysql_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-8e3d1c5e668c98157ddd1b206e351bd9">
<img src="../at2/at2e3/lamps/3_1_mysql_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<blockquote>
<p>Sélectionner &lsquo;mysql-8.0&rsquo; + [entrée]</p>
</blockquote>
<p>
<a href="#image-dccafea941d3d590ef4736ca261b522e" class="lightbox-link">
<img src="../at2/at2e3/lamps/3_2_mysql_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-dccafea941d3d590ef4736ca261b522e">
<img src="../at2/at2e3/lamps/3_2_mysql_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<blockquote>
<p>Sélectionner &lsquo;Ok&rsquo; dans la liste + [entrée]</p>
</blockquote>
<p>
<a href="#image-eb754fc8d2c77aef7180b16b9ba5632e" class="lightbox-link">
<img src="../at2/at2e3/lamps/3_3_mysql_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-eb754fc8d2c77aef7180b16b9ba5632e">
<img src="../at2/at2e3/lamps/3_3_mysql_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt update
</span></span><span class="line"><span class="cl">apt upgrade
</span></span><span class="line"><span class="cl">apt install mysql-server
</span></span></code></pre></div><ul>
<li>indiquer le mot de passe pour l&rsquo;accès à mysql en root et confimer à l&rsquo;écran suivant</li>
</ul>
<p>
<a href="#image-45f7268ff2a5e555929716bdfa61461c" class="lightbox-link">
<img src="../at2/at2e3/lamps/3_4_mysql_apt_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-45f7268ff2a5e555929716bdfa61461c">
<img src="../at2/at2e3/lamps/3_4_mysql_apt_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<blockquote>
<p>choisir l&rsquo;option recommandée (strong password encryption) + [entrée]</p>
</blockquote>
<p>
<a href="#image-e4ddbe8c5156e43b96553e0dd541ea2b" class="lightbox-link">
<img src="../at2/at2e3/lamps/3_5_mysql_apt_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e4ddbe8c5156e43b96553e0dd541ea2b">
<img src="../at2/at2e3/lamps/3_5_mysql_apt_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>test de mysql en CLI</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mysql -u root -p
</span></span></code></pre></div><p>puis entrer le mot de passe choisi juste avant</p>
<p>
<a href="#image-370f66652586dbcf8093ea41cec99445" class="lightbox-link">
<img src="../at2/at2e3/lamps/3_6_mysql_post_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-370f66652586dbcf8093ea41cec99445">
<img src="../at2/at2e3/lamps/3_6_mysql_post_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<p><code>exit</code> pour sortir</p>
<h2 id="4---php">4 - PHP</h2>
<h3 id="installation-et-configuration-du-langage-php-7x">Installation et configuration du langage PHP 7.x</h3>
<ul>
<li>installation PHP 7.4 sur deb 11</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install php
</span></span></code></pre></div><ul>
<li>édition du fichier php.ini pour modifier le upload max filesize</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /etc/php/7.4/apache2/php.ini
</span></span></code></pre></div><p><em>pour faire une recherche dans nano :
tapper ctrl+w et entrer le texte à rechercher (upload_max) puis entrée</em></p>
<p>
<a href="#image-d24062ae6883e46f889dfd1a21b5d5b5" class="lightbox-link">
<img src="../at2/at2e3/lamps/4_1_php.ini.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d24062ae6883e46f889dfd1a21b5d5b5">
<img src="../at2/at2e3/lamps/4_1_php.ini.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>redémarrer le service apache2</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><h3 id="création-dun-fichier-info-dans-homeuserwiki-nommé-infophp-avec-le-compte-user">création d’un fichier info dans /home/user/wiki/ nommé info.php avec le compte user</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">su user
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /home/user/wiki/info.php
</span></span></code></pre></div><p>
<a href="#image-5bd47ff0e95c438dbef2f49c6b45d659" class="lightbox-link">
<img src="../at2/at2e3/lamps/4_2_info.php.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5bd47ff0e95c438dbef2f49c6b45d659">
<img src="../at2/at2e3/lamps/4_2_info.php.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>repasser en root</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">su -
</span></span></code></pre></div><p>ou</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span></code></pre></div><ul>
<li>lancer un navigateur sur <a href="https://wiki.infra.lan/info.php" target="_blank">https://wiki.infra.lan/info.php</a></li>
</ul>
<p>
<a href="#image-6087dee9c8fafb16e5370c6a79438b8c" class="lightbox-link">
<img src="../at2/at2e3/lamps/4_3_info_php.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-6087dee9c8fafb16e5370c6a79438b8c">
<img src="../at2/at2e3/lamps/4_3_info_php.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<h3 id="installation-des-libs-php-souvent-utilisées-par-les-cms">installation des libs PHP souvent utilisées par les cms</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install php-curl php-gd php-zip php-apcu php-xml php-ldap php-mbstring
</span></span><span class="line"><span class="cl">apt install php-mysql
</span></span></code></pre></div><ul>
<li>recharger apache2</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><h2 id="5---phpmyadmin">5 - PhpMyAdmin</h2>
<h3 id="installation-et-configuration-de-phpmyadmin">Installation et configuration de PhpMyAdmin</h3>
<ul>
<li>installation de PhpMyAdmin</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install phpmyadmin
</span></span></code></pre></div><p><strong>ATTENTION</strong> : à la page de sélection du serveur web, appuyer sur [espace] pour sélectionner &lsquo;apache2&rsquo; avant de valider :</p>
<p>
<a href="#image-05a89411bd881e09a212609e0267051d" class="lightbox-link">
<img src="../at2/at2e3/lamps/5_1_pma_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-05a89411bd881e09a212609e0267051d">
<img src="../at2/at2e3/lamps/5_1_pma_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<blockquote>
<p>répondre OUI pour utiliser dbconfig-common</p>
</blockquote>
<p>
<a href="#image-5466b8db8e9d42cb1736544b554321af" class="lightbox-link">
<img src="../at2/at2e3/lamps/5_2_pma_install.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5466b8db8e9d42cb1736544b554321af">
<img src="../at2/at2e3/lamps/5_2_pma_install.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<blockquote>
<p>entrer un mot de passe pour PhpMyAdmin dans mysql et confirmer à l&rsquo;écran suivant</p>
</blockquote>
<blockquote>
<p>entrer un mot de passe pour l&rsquo;administrateur de PhpMyAdmin</p>
</blockquote>
<ul>
<li>et voir ce <a href="https://www.digitalocean.com/community/questions/how-do-i-change-phpmyadmin-access-url" target="_blank">lien</a> pour l&rsquo;alias (pour accéder à PhpMyAdmin via pma) =&gt;</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /etc/phpmyadmin/apache.conf
</span></span></code></pre></div><p>
<a href="#image-1525d93bfc180b3d473d9bca24558100" class="lightbox-link">
<img src="../at2/at2e3/lamps/5_3_pma_alias.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-1525d93bfc180b3d473d9bca24558100">
<img src="../at2/at2e3/lamps/5_3_pma_alias.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>recharger apache2</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><h3 id="changement-des-droits-root-avec-">Changement des droits root avec %</h3>
<ul>
<li>
<p>se connecter en root sur phpmyadmin sur un navigateur à l&rsquo;url <a href="https://wiki.infra.lan/pma" target="_blank">https://wiki.infra.lan/pma</a></p>
</li>
<li>
<p>dans le cadre de gauche, déplier l&rsquo;entrée mysql et sélectioner la table &lsquo;user&rsquo;</p>
</li>
<li>
<p>dans la ligne &lsquo;root&rsquo; du cadre principal, entrer % à la place de localhost</p>
</li>
</ul>
<p>
<a href="#image-50130b4b0082b4ed1d8096977780890a" class="lightbox-link">
<img src="../at2/at2e3/lamps/5_4_pma_root.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-50130b4b0082b4ed1d8096977780890a">
<img src="../at2/at2e3/lamps/5_4_pma_root.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<h3 id="création-via-pma-dans-mysql-dun-utilisateur-user-qui-aura-tous-les-droits-sur-la-base-user-mais-pas-ailleurs">Création via PMA dans MYSQL d&rsquo;un utilisateur &lsquo;user&rsquo; qui aura tous les droits sur la base &lsquo;user&rsquo; mais pas ailleurs</h3>
<ul>
<li>aller à l&rsquo;accueil de pma</li>
</ul>
<p>
<a href="#image-2d5524a2e403e280212105ac4964c0c0" class="lightbox-link">
<img src="../at2/at2e3/lamps/5_5_pma_user.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-2d5524a2e403e280212105ac4964c0c0">
<img src="../at2/at2e3/lamps/5_5_pma_user.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>cliquer sur l&rsquo;onglet &lsquo;Comptes utilisateurs&rsquo; puis le lien &lsquo;Ajouter un compte utilisateur&rsquo;</li>
</ul>
<p>
<a href="#image-fc749e5c2bc8c587c26426ab833a7d49" class="lightbox-link">
<img src="../at2/at2e3/lamps/5_6_pma_user.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-fc749e5c2bc8c587c26426ab833a7d49">
<img src="../at2/at2e3/lamps/5_6_pma_user.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>saisir le nom d&rsquo;utilisateur et son mot de passe + confirmation puis activer la case à cocher &lsquo;Créer une base portant son nom&hellip;&rsquo; et rien d&rsquo;autre. Cliquer le bouton &lsquo;Exécuter&rsquo; tout en bas à droite de la page.</li>
</ul>
<p>
<a href="#image-317a089c2ebabd0aab1c2e153cc7cdc9" class="lightbox-link">
<img src="../at2/at2e3/lamps/5_7_pma_user.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-317a089c2ebabd0aab1c2e153cc7cdc9">
<img src="../at2/at2e3/lamps/5_7_pma_user.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Recharger les privileges (droits) via la zone de texte de l&rsquo;onglet SQL en saisissant la commande :</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">FLUSH</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Se déconnecter en haut à gauche et tester les droits du nouvel utilisateur</li>
</ul>
<h2 id="6---ftp">6 - FTP</h2>
<h3 id="installation-et-configuration-du-service-ftp">Installation et configuration du service FTP</h3>
<ul>
<li>installation du service ftp</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install vsftpd
</span></span></code></pre></div><ul>
<li>copie de sauvegarde de /etc/vsftpd.conf avant édition</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mv /etc/vsftpd.conf /etc/vsftpd.bak
</span></span></code></pre></div><ul>
<li>configuration du service avec chrootage, passv et ssl</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /etc/vsftpd.conf
</span></span></code></pre></div><p><a href="../at2/at2e3/lamps/vsftpd.conf.txt">Un exemple de fichier vsftpd.conf</a> (ici renommé en .txt pour en faciliter la lecture)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service vsftpd restart
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nmap 127.0.0.1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nmap votre_ip
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service vsftpd status
</span></span></code></pre></div><ul>
<li>se connecter en sftp avec filezilla client</li>
</ul>
<p>
<a href="#image-229aae0e6d3741fa5e4505ea419153d2" class="lightbox-link">
<img src="../at2/at2e3/lamps/6_1_ftp_filezilla.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-229aae0e6d3741fa5e4505ea419153d2">
<img src="../at2/at2e3/lamps/6_1_ftp_filezilla.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<h2 id="7---samba">7 - SAMBA</h2>
<h3 id="installation-et-configuration-du-partage-samba">Installation et configuration du partage SAMBA</h3>
<ul>
<li>config de samba (samba pré-installé en amont)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cp /etc/samba/smb.conf /etc/samba/smb.bak
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /etc/samba/smb.conf
</span></span></code></pre></div><p>
<a href="#image-5631a0cda1c7944796d8cb44d51967db" class="lightbox-link">
<img src="../at2/at2e3/lamps/7_1_samba_smb.conf.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5631a0cda1c7944796d8cb44d51967db">
<img src="../at2/at2e3/lamps/7_1_samba_smb.conf.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>relancer les 2 services</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service nmbd restart
</span></span><span class="line"><span class="cl">service smbd restart
</span></span></code></pre></div><ul>
<li>tester notre fichier de conf</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">testparm
</span></span></code></pre></div><ul>
<li>chiffrer le user de la base de compte local Linux à la sauce windows</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">smbpasswd -a user
</span></span></code></pre></div><h3 id="il-n-y-a-plus-quà-tester-via-lexplorateur-de-fichier-avec">il n&rsquo; y a plus qu&rsquo;à tester via l&rsquo;explorateur de fichier avec</h3>
<p>
<a href="#image-a326c2bbb50bb09564446948c44f9e4f" class="lightbox-link">
<img src="../at2/at2e3/lamps/7_2_samba_explorer.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a326c2bbb50bb09564446948c44f9e4f">
<img src="../at2/at2e3/lamps/7_2_samba_explorer.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<h2 id="8---script-de-sauvegarde-des-bases-de-donnees">8 - Script de sauvegarde des bases de données</h2>
<p><em><strong>Le but est de créer une tâche automatique qui compresse en zip le dossier contenant les bases et qui le sauve dans un dossier à la date du jour ainsi que le contenu du dossier wiki</strong></em></p>
<ul>
<li>on crée le script dans /root</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /root
</span></span><span class="line"><span class="cl">touch backup.sh
</span></span></code></pre></div><ul>
<li>on lui donne les droits d&rsquo;exécution</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod +x backup.sh
</span></span></code></pre></div><ul>
<li>on l&rsquo;édite</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano backup.sh
</span></span></code></pre></div><p>avec :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash  
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#Scipt de backup auto de la BDD et du wiki pour le site user  </span>
</span></span><span class="line"><span class="cl"><span class="c1">#V1.0 par UserName le Date  </span>
</span></span><span class="line"><span class="cl">clear  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> Compression des fichiers...  
</span></span><span class="line"><span class="cl">7zip -rq /home/user/<span class="k">$(</span>date +%Y%m%d%H%M%S<span class="k">)</span>_wiki_backup-fichiers.zip /home/user/wiki  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> Dump de la base de données...  
</span></span><span class="line"><span class="cl">mysqldump -u root -p <span class="s1">&#39;toor&#39;</span> --databases user &gt; /home/user/_wiki_backup-base.sql  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> Compression de la base de données...  
</span></span><span class="line"><span class="cl">zip -q /home/user/<span class="k">$(</span>date +%Y%m%d%H%M%S<span class="k">)</span>_wiki_backup-base.zip /home/user/_wiki_backup-base.sql  
</span></span><span class="line"><span class="cl">rm /home/user/_wiki_backup-base.sql  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> Terminé !
</span></span></code></pre></div><p>(La chaine &rsquo;toor&rsquo; est le mot de passe de root sur mysql. Choisir un MDP fort pour un usage en production)</p>
<h3 id="pour-tester-le-script">Pour tester le script</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /root
</span></span><span class="line"><span class="cl">./backup.sh
</span></span></code></pre></div><p>ou plus simplement</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/root/backup.sh
</span></span></code></pre></div><h3 id="pour-automatiser-ce-script-">Pour automatiser ce script :</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">crontab -e
</span></span></code></pre></div><ul>
<li>choisir [1] pour ouverture avec nano</li>
</ul>
<h3 id="rajouter-la-ligne-cf-httpcrontabguruhttpcrontabguru">rajouter la ligne (cf <a href="http://crontab.guru" target="_blank">http://crontab.guru</a>)</h3>
<blockquote>
<p>*/5 * * * * /root/backup.sh</p>
</blockquote>
<ul>
<li>cette directive exécute le script toutes les 5 minutes</li>
</ul>
<h2 id="9---installation-du-certificat-dans-webmin">9 - Installation du certificat dans Webmin</h2>
<p>Dans un navigateur, accéder à l&rsquo;url : <a href="https://wiki.infra.lan:10000" target="_blank">https://wiki.infra.lan:10000</a> et se connercter avec root</p>
<p>Puis dans Webmin &gt; Webmin Configuration &gt; SSL encryption (version en) :</p>
<p>
<a href="#image-fb423c990ce2eec8d86036d1aacd5c9b" class="lightbox-link">
<img src="../at2/at2e3/lamps/9_1_webmin_cert.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-fb423c990ce2eec8d86036d1aacd5c9b">
<img src="../at2/at2e3/lamps/9_1_webmin_cert.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<p>Appliquer les changements en cliquant le bouton &lsquo;Save&rsquo; en bas à gauche de la page ; attendre quelques secondes puis recharger la page.</p>
<h2 id="10---mediawiki">10 - MediaWiki</h2>
<h3 id="installation-de-mediawiki">installation de MediaWiki</h3>
<ul>
<li>installation de l&rsquo;extention PHP intl (requise pour MediaWiki)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install php-intl
</span></span><span class="line"><span class="cl">service apache2 restart
</span></span></code></pre></div><ul>
<li>installation de MediaWiki</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /home/user
</span></span><span class="line"><span class="cl">wget https://releases.wikimedia.org/mediawiki/1.38/mediawiki-1.38.2.zip
</span></span><span class="line"><span class="cl">unzip mediawiki-1.38.2.zip
</span></span><span class="line"><span class="cl">rm -R wiki
</span></span><span class="line"><span class="cl">mv mediawiki-1.38.2 wiki
</span></span><span class="line"><span class="cl">chown -R www-data:www-data /home/user/wiki
</span></span><span class="line"><span class="cl">chmod -R <span class="m">775</span> /home/user/wiki
</span></span></code></pre></div><h3 id="terminer-linstallation-de-mediawiki-via-le-navigateur">Terminer l&rsquo;installation de MediaWiki via le navigateur</h3>
<ul>
<li>
<p>Dans le navigateur, aller à <a href="https://wiki.infra.lan" target="_blank">https://wiki.infra.lan</a></p>
</li>
<li>
<p>cliquer sur le lien proposé pour démarrer l&rsquo;installation</p>
</li>
<li>
<p>à la page &lsquo;Connexion à la base de données&rsquo;, choisir :</p>
</li>
</ul>
<blockquote>
<ul>
<li><em>Type de base de données</em> : MariaDB, MySQL , ou compatible</li>
<li><em>Nom d’hôte de la base de données</em> : localhost</li>
<li><em>Nom de la base de données (sans tirets)</em> : user</li>
<li><em>Préfixe des tables de la base de données (sans tirets)</em> : mw_</li>
<li><em>Nom d’utilisateur de la base de données</em> : user</li>
<li><em>Mot de passe de la base de données</em> : le mot de passe pour user défini plus haut dans PhpMyAdmin</li>
</ul>
</blockquote>
<ul>
<li>
<p>à la page &lsquo;Nom&rsquo;, nommer le wiki (ie : wiki infra.lan) ; c&rsquo;est le nom qui figurera dans la barre de titre du navigateur ; puis renseigner un utilisateur qui sera administrateur du wiki (MDP 10 caractères minimum)</p>
</li>
<li>
<p>On peut s&rsquo;arrêter là pour cet exemple. Il est néanmoins possible de spécifier des greffons supplémentaires en poursuivant l&rsquo;installation.</p>
</li>
<li>
<p>Un fichier (LocalSettings.php) est généré et téléchargé par le navigateur. Il doit être copié à la racine wiki (dossier /home/user/wiki) avec Filezilla ou Samba. Si problème d&rsquo;écriture dans le dossier wiki, ressaisir les 3 commandes chown, usermod et chmod de la section apache telles que décrites au début de ce document.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chown -R www-data:www-data /home/user/wiki
</span></span><span class="line"><span class="cl">usermod -a -G www-data user
</span></span><span class="line"><span class="cl">chmod -R <span class="m">775</span> /home/user/wiki
</span></span></code></pre></div><h2 id="le-wiki-est-opérationnel-sur-httpswikiinfralanhttpswikiinfralan">Le wiki est opérationnel sur <a href="https://wiki.infra.lan" target="_blank">https://wiki.infra.lan</a></h2>
<p>
<a href="#image-9f305a4eb3b62699ae27e3b52dc33113" class="lightbox-link">
<img src="../at2/at2e3/lamps/10_1_wiki.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9f305a4eb3b62699ae27e3b52dc33113">
<img src="../at2/at2e3/lamps/10_1_wiki.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>
<p>On peut consulter la base de donnée en se connectant avec user à PhpMyAdmin sur <a href="https://wiki.infra.lan/pma" target="_blank">https://wiki.infra.lan/pma</a> : l&rsquo;installation de MediaWiki a généré 58 tables.</p>
<p>
<a href="#image-1ef5a0a255b896c308604645bb80188e" class="lightbox-link">
<img src="../at2/at2e3/lamps/10_1_wiki_pma.PNG" alt="Capture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-1ef5a0a255b896c308604645bb80188e">
<img src="../at2/at2e3/lamps/10_1_wiki_pma.PNG" alt="Capture" class="lightbox-image" loading="lazy">
</a></p>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="chapter">
<div class="article-subheading">Chapitre 4</div>
<h1 id="maintenir-et-exploiter-un-environnement-virtualisé">Maintenir et exploiter un environnement virtualisé</h1>

<hr>
<h4 id="1-tp-infraat2at2e4tp-infra">1. <a href="../at2/at2e4/tp-infra/">TP Infra</a></h4>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Sous-sections de Maintenir et exploiter un environnement virtualisé</h1>
          <article class="chapter">
<div class="article-subheading">Exemple 4</div>
<h1 id="tp-infra">TP Infra</h1>

<h2 id="tp-infra-en-cluster-esxi">TP infra en cluster ESXi</h2>
<p>Voici les schémas réseaux du TP infra dirigé par Karl Fricker</p>
<p>
<a href="#image-f01774925ca0946b7da2d9c01b9c13e3" class="lightbox-link">
<img src="../at2/at2e4/tp-infra/Infra.drawio.png" alt="Infra" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f01774925ca0946b7da2d9c01b9c13e3">
<img src="../at2/at2e4/tp-infra/Infra.drawio.png" alt="Infra" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-82635d45b1a9fdc5a6911accce0e97cd" class="lightbox-link">
<img src="../at2/at2e4/tp-infra/ClusterESXi.drawio.png" alt="Cluster ESXi" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-82635d45b1a9fdc5a6911accce0e97cd">
<img src="../at2/at2e4/tp-infra/ClusterESXi.drawio.png" alt="Cluster ESXi" class="lightbox-image" loading="lazy">
</a></p>
<hr>
<table>
<thead>
<tr>
<th><strong>CHECKLIST</strong></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ROUTEUR /GTW</strong></td>
<td></td>
</tr>
<tr>
<td>Installation d&rsquo;un PFSense</td>
<td>VRAI</td>
</tr>
<tr>
<td>Configuration du WAN</td>
<td>VRAI</td>
</tr>
<tr>
<td>Configuration du LAN en classe B/24</td>
<td>VRAI</td>
</tr>
<tr>
<td>Définir les interfaces optionnelles pour chaque VLAN</td>
<td>VRAI</td>
</tr>
<tr>
<td>Les clients derrière le routeur ont internet</td>
<td>VRAI</td>
</tr>
<tr>
<td>Configuration de l&rsquo;accès en https only sur le port 666</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td>Définir un SSID petinent avec une shared key WPA2</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td>Sécuriser l&rsquo;équipement</td>
<td>VRAI</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>ESXi</strong></td>
<td></td>
</tr>
<tr>
<td>Installation d&rsquo;un ESXi 7 sur une machine hôte physique</td>
<td>VRAI</td>
</tr>
<tr>
<td>1 datastore local est configuré</td>
<td>VRAI</td>
</tr>
<tr>
<td>A minima deux cartes réseaux sont configurées</td>
<td>VRAI</td>
</tr>
<tr>
<td>Les VMS ne passent pas toutes par la même IF</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&quot;ESXI peut s&rsquo;authentifier sur le LDAP de DC1</td>
<td>FAUX</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>DC1</strong></td>
<td></td>
</tr>
<tr>
<td>un domaine du type toto.lan a été crée</td>
<td>VRAI</td>
</tr>
<tr>
<td>la zone reverse est crée</td>
<td>VRAI</td>
</tr>
<tr>
<td>Les roots servers DNS sont à jour</td>
<td>VRAI</td>
</tr>
<tr>
<td>Un redirecteur vers 1.1.1.1 est créé</td>
<td>VRAI</td>
</tr>
<tr>
<td>1000 users ont été déposés dans une OU sur DC1 via un script powershell (me demander si besoin)</td>
<td>VRAI</td>
</tr>
<tr>
<td>A minima un client peut joindre le domaine</td>
<td>VRAI</td>
</tr>
<tr>
<td>La console Sites &amp; Service a été configuré pour une réplication à 15 minutes</td>
<td>VRAI</td>
</tr>
<tr>
<td>La console Sites &amp; Service a été configuré pour un subnet classe B/25</td>
<td>VRAI</td>
</tr>
<tr>
<td>La console Sites &amp; Service a été configuré pour rédéfinir le default-first-site</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>DC2</strong></td>
<td></td>
</tr>
<tr>
<td>Le rôle active directory est installé</td>
<td>VRAI</td>
</tr>
<tr>
<td>Le DC2 réplique les users du DC1</td>
<td>VRAI</td>
</tr>
<tr>
<td>Le DC2 fait également la bascule DNS</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>SHARE</strong></td>
<td></td>
</tr>
<tr>
<td>La console quotas et filtre est installé</td>
<td>VRAI</td>
</tr>
<tr>
<td>Chaque utilisateur possède un quota de 500 Mo</td>
<td>VRAI</td>
</tr>
<tr>
<td>On ne peut pas déposer de fichier MP3 sur ce partage</td>
<td>VRAI</td>
</tr>
<tr>
<td>Un dossier commun est disponible pour tout le monde en R/W</td>
<td>VRAI</td>
</tr>
<tr>
<td>Un dossier perso est disponible en R/W pour chaque User</td>
<td>VRAI</td>
</tr>
<tr>
<td>Dans chaque poste client via une GPO on doit pouvoir propager le mappage des lecteurs de partage</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>SWITCH</strong></td>
<td></td>
</tr>
<tr>
<td>On peut y accéder par un cable console</td>
<td>VRAI</td>
</tr>
<tr>
<td>On peut y accéder par l&rsquo;interface web sur une IP Fixe si il le permet</td>
<td>VRAI</td>
</tr>
<tr>
<td>les vlans y sont configurés comme vu en cours packet tracer</td>
<td>VRAI</td>
</tr>
<tr>
<td>les deux IF de l&rsquo;ESXI sont sur chaque switch</td>
<td>VRAI</td>
</tr>
<tr>
<td>Le switch cisco est réinitialisé</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>GLPI</strong></td>
<td></td>
</tr>
<tr>
<td>Installer un debian 10/11 sur une VM</td>
<td>VRAI</td>
</tr>
<tr>
<td>Installer un LAMPS</td>
<td>VRAI</td>
</tr>
<tr>
<td>Installer la webapp GLPI</td>
<td>VRAI</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>VRAI</td>
</tr>
<tr>
<td>Configurer GLPI pour offrir un helpdesk de base</td>
<td>VRAI</td>
</tr>
<tr>
<td>Configurer un connecteur LDAP</td>
<td>VRAI</td>
</tr>
<tr>
<td>Ouvrir un workflow de ticket pour un user</td>
<td>VRAI</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>XIVO IPBX</td>
<td></td>
</tr>
<tr>
<td>Installer la dernière distribution de XIVO</td>
<td>VRAI</td>
</tr>
<tr>
<td>Configurer une entité</td>
<td>FAUX</td>
</tr>
<tr>
<td>Configurer un plan d&rsquo;adressage locale de numérotation entre 100 et 199</td>
<td>FAUX</td>
</tr>
<tr>
<td>L&rsquo;équipement est pinguable via un FQDN pertinent ou son alias</td>
<td>FAUX</td>
</tr>
<tr>
<td>Installation des greffons pour les ciscophone et les des polycom</td>
<td>FAUX</td>
</tr>
<tr>
<td>Création de 6 comptes utlisateurs</td>
<td>FAUX</td>
</tr>
<tr>
<td>Installation sur android/IOS de zoiper ou Jitsi</td>
<td>FAUX</td>
</tr>
<tr>
<td>Installation sur client windows de zoiper</td>
<td>FAUX</td>
</tr>
<tr>
<td>La communication en interne est possible</td>
<td>FAUX</td>
</tr>
<tr>
<td>Le XIVO fait DCHP pour le VLAN</td>
<td>FAUX</td>
</tr>
<tr>
<td>Configurer un connecteur LDAP</td>
<td>FAUX</td>
</tr>
</tbody>
</table>
<ul>
<li><em>La machine Xivo n&rsquo;a pas été terminé faute de temps et d&rsquo;une mauvaise manipulation en fin de TP.</em></li>
</ul>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="chapter">
<div class="article-subheading">Chapitre 5</div>
<h1 id="maintenir-et-exploiter-un-domaine-active-directory-et-les-serveurs-windows">Maintenir et exploiter un domaine Active Directory et les serveurs Windows</h1>

<hr>
<h4 id="1-migration-adat2at2e5ad">1. <a href="../at2/at2e5/ad/">Migration AD</a></h4>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Sous-sections de Maintenir et exploiter un domaine Active Directory et les serveurs Windows</h1>
          <article class="chapter">
<div class="article-subheading">Exemple 1</div>
<h1 id="migrations-active-directory">Migrations Active Directory</h1>

<p>
<a href="#image-51ff8341482606a66c4ab0e63afed2e0" class="lightbox-link">
<img src="../at2/at2e5/ad/001-logoAD.png" alt="logo" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-51ff8341482606a66c4ab0e63afed2e0">
<img src="../at2/at2e5/ad/001-logoAD.png" alt="logo" class="lightbox-image" loading="lazy">
</a></p>
<h2 id="introduction">Introduction</h2>
<p>Entreprise : 2 DNS : interne et externe<br>
L&rsquo;AD et le DNS sont fusionnés en entreprise.<br>
L&rsquo;AD est le rôle principal dans une entreprise, il permet la sécurité, l&rsquo;authentification utilisateur. On y retrouve les comptes, les mdp, les groupes, les serveurs.<br>
C&rsquo;est le noyau d&rsquo;une infrastructure système. Tout tourne autour de lui.<br>
C&rsquo;est grâce à l&rsquo;AD qu&rsquo;on peut faire du SSO (jeton pour la &ldquo;journée&rdquo; d&rsquo;authentification).</p>
<h2 id="dns">DNS</h2>
<table>
<thead>
<tr>
<th style="text-align:center">DNS exterieur</th>
<th style="text-align:center">DNS interne lié à l&rsquo;AD</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">(<strong>1</strong>) FAI &gt; pool IP publique + ligne internet</td>
<td style="text-align:center">(1)Onglet redirecteur : les 2 IP publique des DNS externes (pour rebalancer si non connnu en interne)</td>
</tr>
<tr>
<td style="text-align:center">NAT IP internet vers IP publique</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">(<strong>2</strong>) Fournisseur nom de domaine &gt; DNS public + zone DNS exterieure</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">Mep lien DNS publique sur IP publique</td>
<td style="text-align:center">mep lien vers IP privées/internes sur enregistrements et noms</td>
</tr>
<tr>
<td style="text-align:center">A (nom&gt;ip), TXT, MX (<em>mail</em>), PTR (<em>reverse A ; pas de pointeurs dans un server DNS publique</em>), NS (<em>server DNS</em>), SOA (e<em>nr principal dns</em>), CNAME (<em>autre nom</em>)</td>
<td style="text-align:center">Idem : A, TXT, MX, PTR, NS, SOA, CNAME</td>
</tr>
<tr>
<td style="text-align:center">Zone DNS ext = on fait pointer IP publique vers ex. <code>intranet.tssr.net</code></td>
<td style="text-align:center">IP privée ( (<strong>a</strong>) <code>192.168.20.240 srv.web)</code> &gt; <code>.lan</code> (<code>srv.web.lan</code>) en record A,  (<strong>b</strong>) CNAME &gt; vers le <code>.lan</code> (<code>intranet serv.web.lan</code>) OU (<strong>c</strong>) enregistrement zone A directement <code>icp.fr &gt; intranet.icp.fr</code> comme ça que ce soit en interne/externe, accès au serveur avec la même nomenclature)</td>
</tr>
</tbody>
</table>
<p>Les enregistrements sont les mêmes pour les zones DNS internes et externes.</p>
<p><strong>PROGRAMME:</strong></p>
<ul>
<li>Monter une AD unique à nous tous, faire tout ce qu&rsquo;on vas retrouver en entreprise (ex: comptes, groupes, mdp, OU); les bonnes pratiques.</li>
<li>On fera des GPO qui sont le plus utilisées en entreprise.</li>
<li>Sécurité NTFS (sécurité sur les dossiers et les fichiers).</li>
</ul>
<h2 id="active-directory">ACTIVE DIRECTORY</h2>
<p><em>AD = LDAP (LDAPs = fonction sécurisé) = Annuaire = Annuaire d&rsquo;identité</em></p>
<p>Port AD 389 / Port LDAS 636</p>
<p>
<a href="#image-434d699d618a8bdcd16984362c700736" class="lightbox-link">
<img src="../at2/at2e5/ad/002-schemaAD1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-434d699d618a8bdcd16984362c700736">
<img src="../at2/at2e5/ad/002-schemaAD1.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>AD =&gt; c&rsquo;est une forêt =&gt; la forêt c&rsquo;est le schéma qui est remplie d&rsquo;attributs.
Dans cette forêt, il peut y avoir des domaines, voir des sous-domaines des domaines.
En entreprise, pour éviter de complexifier son AD, on ne fait qu&rsquo;un domaine, voir deux sous-domaines (messagerie et compte). On peut même simuler des sous-domaines pour ne pas complexifier l&rsquo;AD. Grâce à cela on n&rsquo;as qu&rsquo;un seul et unique domaine à gérer.
Le login côté AD s&rsquo;apelle l&rsquo;UPN (équivalent de l&rsquo;adresse mail)<br>
AD permet de gérer: les comptes génériques, les mdp, les groupes de sécurité, listes de diffusion, machines, serveur, GPO, BALS (implicitement c&rsquo;est un compte / BALS: Boite aux lettres) générique, BALS équipements, BALS Salle.</p>
<p>
<a href="#image-a06a2eeedbaa1f0009f2ebd752fd2368" class="lightbox-link">
<img src="../at2/at2e5/ad/003-schemaForetAD.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a06a2eeedbaa1f0009f2ebd752fd2368">
<img src="../at2/at2e5/ad/003-schemaForetAD.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Les 5 étapes de l&rsquo;installtion d&rsquo;un magnifique serveur neuf :</p>
<ul>
<li>Configurer un RAID</li>
<li>Installation Windows Server</li>
<li>Configuration carte réseau (no DHCP, tout est fixé)</li>
<li>Faire les MàJ Microsoft</li>
<li>Antivirus</li>
</ul>
<p><strong>Les SERVEUR AD sont les CONTROLEURS DE DOMAINES</strong><br>
Ils sont aussi serveurs DNS externes.<br>
Les bonnes pratiques :</p>
<ul>
<li>Ce sont deux serveurs par site. Un contrôleur de domaine ne doit rien faire d&rsquo;autres.</li>
<li>Ils doivent être physique. À la limite, un des deux peut être virtualisé (par exemple, sur une infra VMware qui crash et que les deux serveur sont virtualisé, c&rsquo;est la misère)</li>
<li>Le principal doit rester en physique. Il héberge les rôles FSMO.</li>
<li>La réplication AD permet de se synchroniser dans les 15 minutes entre tout les contrôleurs de domaine.</li>
</ul>
<p>Dans le cas d&rsquo;un multi site :</p>
<table>
<thead>
<tr>
<th style="text-align:center">Paris</th>
<th style="text-align:center"></th>
<th style="text-align:center">Marseille</th>
<th style="text-align:center"></th>
<th style="text-align:center">Lyon</th>
<th style="text-align:center"></th>
<th style="text-align:center">Clermont</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">DC Prinicpal / DC Secondaire</td>
<td style="text-align:center">&ndash;&gt; VPN IPSEC SITE A SITE &ndash;&gt;</td>
<td style="text-align:center">DC Secondaire / DC Secondaire</td>
<td style="text-align:center">&ndash;&gt; VPN IPSEC SITE A SITE &ndash;&gt;</td>
<td style="text-align:center">DC Secondaire / DC Secondaire</td>
<td style="text-align:center">&ndash;&gt; VPN IPSEC SITE A SITE &ndash;&gt;</td>
<td style="text-align:center">DC Secondaire / DC Secondaire</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">Replication AD dans le tunnel</td>
<td style="text-align:center"></td>
<td style="text-align:center">Replication AD dans le tunnel</td>
<td style="text-align:center"></td>
<td style="text-align:center">Replication AD dans le tunnel</td>
<td></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">Ad src 172.16.0.0/24 vers ad dest 172.30.0.0/24</td>
<td style="text-align:center"></td>
<td style="text-align:center">Ad src 172.30.0.0/24 vers dest 172.62.0.0/24</td>
<td style="text-align:center"></td>
<td style="text-align:center">Ad src 172.62.0.0 vers ad dest 172.16.0.0/24</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Bonne pratique</strong> :<br>
Les 4 sites sont reliés en VPN IPSEC site à site.<br>
Sur de l&rsquo;intersite, faire passer la réplication AD dans le tunel.<br>
Tout les Firewalls proposent le VPN IPSEC site à site. Les configurer exterieurements (sur Paris, mettre l&rsquo;Ip publique de Marseille, ainsi que les méthodes d&rsquo;encryption. Il faut qu&rsquo;elle soit égale des 2 côtés. Idem pour la clé secrete partagée).<br>
Mettre la même marque de firewall sur tout ces sites*</p>
<h2 id="ad-sur-windows-serveur-2019">AD SUR WINDOWS SERVEUR 2019</h2>
<h3 id="construire-un-contrôleur-de-domaine-principal">Construire un contrôleur de domaine principal</h3>
<ul>
<li>Gérer &ldquo;Ajout de rôles et des fonctionnalités&rdquo;</li>
<li>Assisstant Ajout de rôles :
<ul>
<li>Rôles de serveurs</li>
<li>Cocher Service AD DS (Gestion de Stratégie de Groupe déjà coché)</li>
<li>Lancer l&rsquo;installation du rôle</li>
</ul>
</li>
<li>Drapeau Orange en haut à droite &ldquo;Promouvoir se serveur en contrôleur de domaine&rdquo;</li>
<li>Assistant de Configuration des services de domaines AD
<ul>
<li>Configuration de déploiement
<ul>
<li>&ldquo;Ajouter une nouvelle forêt&rdquo;</li>
<li>Nom de domaine racine &ldquo;om.lan&rdquo;</li>
</ul>
</li>
<li>Options du contrôleur de domaine
<ul>
<li>Serveur DNS : laissé coché</li>
<li>Catalogue Global (rôle de base)</li>
<li>Mot de passe: dadfba16$</li>
</ul>
</li>
<li>Options supplémentaires
<ul>
<li>il le déduit seul &ldquo;OM&rdquo;</li>
</ul>
</li>
<li>Chemin d&rsquo;accès
<ul>
<li>On retrouve le chemin de l&rsquo;enregistrement de la BDD.</li>
<li><em>Bonne Pratique: sauvegarder les logs sur une partition D</em></li>
</ul>
</li>
<li>Lancer l&rsquo;installation</li>
</ul>
</li>
</ul>
<p>L&rsquo;AD se crée. Cela crée le schéma, la forêt, les FSMO.<br>
Sur un contrôleur de domaine, lorsque le domaine est crée, la notion d&rsquo;Admin local, c&rsquo;est terminé. On rentre obligatoirement en ADMINISTRATEUR DU DOMAINE.</p>
<p><strong>Vérification et première configuration</strong></p>
<ul>
<li>
<p>La première chose à faire c&rsquo;est de modifier le DNS de la carte réseau du serveur. On met l&rsquo;adresse Ip de lui-même car à partir de maintenant il est aussi serveur DNS.</p>
</li>
<li>
<p><strong>Outils Administration, Utilisateur et Ordinateurs Active Directory</strong></p>
<ul>
<li>On verifie &hellip;. et catalogue global.</li>
<li>Clique-droit, Maitre d&rsquo;opération :
On a les 3 rôles FSMO</li>
</ul>
</li>
<li>
<p><strong>Outils Administration, DNS</strong></p>
<ul>
<li>On vérifie que notre domaine est crée en zone directe.</li>
<li>Notre zone reverse n&rsquo;est pas crée, il faut la créer.
<ul>
<li>clique-droit, ajouter une nouvelle zone.</li>
<li>Ajouter le pointeur PTR du Record A de la zone directe.</li>
</ul>
</li>
<li>Clique-droit, Propriété sur le serveur DNS
<ul>
<li>Ajouter nos DNS de FAI dans l&rsquo;onglet Redirecteurs</li>
</ul>
</li>
<li><em><strong>Cela permet à l&rsquo;exterieur (l&rsquo;internet) de pointer vers le serveur interne.</strong></em></li>
</ul>
</li>
<li>
<p><strong>Outils Administration, Sites et Services Active Directory</strong></p>
<ul>
<li>Default-First-Site-Name
<ul>
<li>C&rsquo;est le site sur lequel vous avez mis le controleur de domaine principal.</li>
<li>On retrouve les contrôleurs de domaine ratachés à ce site.</li>
</ul>
</li>
<li>Inter-Site-Transports
<ul>
<li>IP =&gt; DEFAULTIPSITELINK : C&rsquo;est le moteur de réplication entre les contrôleurs de domaine.
<ul>
<li>Clique-droit, Propriété et mettre la réplication à 15 min.</li>
</ul>
</li>
</ul>
</li>
<li>Subnets (Le plus important ! Il faut déclarer le réseau du site et le ratacher au site.)
<ul>
<li>Clique-droit, Nouveau sous-réseau
<ul>
<li>Préfixe: 192.168.20.0/24 et séléctionner le site</li>
</ul>
</li>
</ul>
</li>
<li>Clique-droit sur Sites, Ajouter un nouveau site. (Par exemple Marseille). Penser à créer le subnet du réseau de Marseille.</li>
</ul>
</li>
<li>
<p><strong>Outils Administration, Domaine et Approbation Active Directory</strong></p>
<ul>
<li>Clique-droit, Propriété sur le Domaine et approbation AD.
<ul>
<li>On peut simuler des créations de sous-domaines ou des domaines.</li>
<li><em><strong>Si on ajoute un nouvel utilisateur, on peut lui crée son identifiant avec la partie mail que l&rsquo;on veut.</strong></em></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Outils Administration, Modèles ADSI</strong></p>
<ul>
<li>Ici on a la retranscritpion de notre AD coté Forêt (CN = attribut)</li>
<li>C&rsquo;est le coeur de l&rsquo;AD</li>
</ul>
</li>
</ul>
<p><em><strong>ATTENTION</strong></em></p>
<table>
<thead>
<tr>
<th style="text-align:center">DNS</th>
<th style="text-align:center">Suffixes UPN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">bobdy.lan</td>
<td style="text-align:center">bobdy.com / bobdy.fr</td>
</tr>
<tr>
<td style="text-align:center">zone directe: bobdy.com ou bobdy.fr</td>
<td style="text-align:center">cela peut être les mêmes</td>
</tr>
<tr>
<td style="text-align:center">SERVEUR</td>
<td style="text-align:center">MESSAGERIE/IDENTIFIANT</td>
</tr>
<tr>
<td style="text-align:center">Dans le DNS interne (voir externe)</td>
<td style="text-align:center">Dans l&rsquo;Active Directory</td>
</tr>
</tbody>
</table>
<h3 id="préparer-le-contrôleur-de-domaine-secondaire">Préparer le contrôleur de domaine secondaire</h3>
<ul>
<li>1ère chose : mettre l&rsquo;IP du contrôleur principal dans les paramêtres de cartes réseau.<br>

<a href="#image-6b14eafbc986d315e5ff48716f1a7551" class="lightbox-link">
<img src="../at2/at2e5/ad/004-ping.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-6b14eafbc986d315e5ff48716f1a7551">
<img src="../at2/at2e5/ad/004-ping.png" alt="" class="lightbox-image" loading="lazy">
</a></li>
<li>2éme chose : ajouter le domaine (On arrive dans les &ldquo;computers&rdquo; sur le controleur principal)<br>

<a href="#image-c8f2f9aab12a7d2b511c76eda264f8db" class="lightbox-link">
<img src="../at2/at2e5/ad/005-ajout_domaine.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c8f2f9aab12a7d2b511c76eda264f8db">
<img src="../at2/at2e5/ad/005-ajout_domaine.png" alt="" class="lightbox-image" loading="lazy">
</a></li>
<li>Enfin se connecter en tant qu&rsquo;administrateur du serveur (dans notre cas, login: OM\Administrateur)</li>
<li>Désactiver le pare-feu qui vient se rajouter suite à la rentrée dans le domaine.</li>
</ul>
<p><em>On clique sur le drapeau orange et on lance &ldquo;promouvoir en controleur de domaine&rdquo; :</em></p>
<ul>
<li>Ajout contrôleur de domaine au domaine existant</li>
<li>Verifier qu&rsquo;on est sur le bon domaine (om.lan)</li>
<li>Vérifier qu&rsquo;on est bien sur le site de &ldquo;Paris&rdquo; et choisir le bon serveur à répliquer.</li>
<li>Rentrer le mdp de restauration.</li>
<li>Verifier que tout est au vert, puis lancer l&rsquo;installation.</li>
</ul>
<p><em>Une fois installé, voilà quelques checks et réglages à faire:</em></p>
<ul>
<li>Carte Réseau: Vérifier les paramêtres de carte. Mettre en DNS primaire nous (192.168.20.51) et en DNS secondaire celle du contrôleur principale (192.168.20.201).</li>
<li>Vérifier dans l&rsquo;AD, que tout les domaines controlleurs secondaires sont bien présents.</li>
<li>DNS: Vérifier qu&rsquo;on a bien récuperé om.lan, om.fr et la zone reverse. Supprimer les records inutiles.</li>
<li>Créer un alias ldapjbf qui pointe sur notre serveur secondaire sur om.lan</li>
<li>Créer un host A ldapjbf qui pointe sur notre serveur secondaire sur om.fr</li>
<li>Allez dans Domaines et Approbation AD et vérifier qu&rsquo;on a bien récuperé les suffixes de noms de domaine.</li>
<li>Allez dans Sites et services AD Sites/Paris/Servers, on doit tous y être. Si on dévellope notre serveur, on doit avoir notre <em>NTDS Settings</em> et enfin à droite on retrouve nos partenaires de réplications.</li>
</ul>
<p>Utilisateurs et ordinateurs AD :</p>
<ul>
<li>Builtin : on s&rsquo;en sert assez peu au quotidien</li>
<li>Computer : OU d&rsquo;arrivée des PC et des servers dans l&rsquo;AD</li>
<li>Domain Controller : AD secondaire</li>
<li>Users : Compte admin + autres comptes par défaut (structures d&rsquo;OU/sous-OU)
<ul>
<li>Administrateur du domaine = niveau le plus bas (accès domaine pour l&rsquo;usage quotidien)</li>
<li>Administrateur du schéma = possibilité de modifier le schéma (op d&rsquo;expertise et de migration)</li>
<li>Administrateur de l&rsquo;entreprise = total accès à toute la structure de l&rsquo;AD</li>
</ul>
</li>
</ul>
<h3 id="comment-se-structure-un-ad">Comment se structure un AD</h3>
<p>Une arborescence AD, ses OU et ses sous-OU, dépendent de l&rsquo;entreprise dans laquelle on se trouve.</p>
<p><strong>Un exemple d&rsquo;organistaion (les bonnes pratiques) :</strong></p>
<ul>
<li>Côté machine:
<ul>
<li>Création OU Serveurs (donc tous serveurs qui arrive dans computers doit être déplacé dans cette OU)</li>
<li>Création OU Machines
<ul>
<li>Création sous-OU: Fixes</li>
<li>Création sous-OU: Portables</li>
</ul>
</li>
<li>Création OU SallesInformatiques (y mettre les pcs de cette salle)</li>
</ul>
</li>
<li>Création OU BALS Générique pour ne pas mélanger les boites aux lettres avec les comptes génériques.</li>
</ul>
<p>On peut décliner par types de machines, au niveau des utilisateurs.<br>
Exemple:</p>
<table>
<thead>
<tr>
<th style="text-align:center">OU global</th>
<th style="text-align:center">COMPTESOFFICE365</th>
<th style="text-align:center">GOUPES</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">sous-OU</td>
<td style="text-align:center">Administratifs</td>
<td style="text-align:center">Sécutité (on peut créer 2 sous OU ex: Appli / Data)</td>
</tr>
<tr>
<td style="text-align:center">sous-OU</td>
<td style="text-align:center">Enseignants</td>
<td style="text-align:center">Liste de Diffusion</td>
</tr>
<tr>
<td style="text-align:center">sous-OU</td>
<td style="text-align:center">Vacataires</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">sous-OU</td>
<td style="text-align:center">Exterieurs</td>
<td></td>
</tr>
</tbody>
</table>
<p><em>Ne pas mettre d&rsquo;espace ou de caractères spéciaux dans les noms d&rsquo;OU</em></p>
<h3 id="on-va-manipuler">ON VA MANIPULER</h3>
<p>Créer une OU principale par personne pour éviter les conflits (Delegue).</p>
<table>
<thead>
<tr>
<th style="text-align:center">Créer des sous-OU:</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ComptesUtilisateurs / Groupes / Dans la sous-OU Groupes, créer deux sous-OU / Securite /ListesDiffusions</td>
<td style="text-align:center">
<a href="#image-a52db4144920dc35eb8d5ce6481c1811" class="lightbox-link">
<img src="../at2/at2e5/ad/006-sous-OU.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a52db4144920dc35eb8d5ce6481c1811">
<img src="../at2/at2e5/ad/006-sous-OU.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">Créer nos trois premiers utilisateurs.</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Mettre le nom en majuscule et le mettre avant le prénom</td>
<td style="text-align:center">
<a href="#image-1a019342edd2f3733de52d62a36c533e" class="lightbox-link">
<img src="../at2/at2e5/ad/007-ajout-user.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-1a019342edd2f3733de52d62a36c533e">
<img src="../at2/at2e5/ad/007-ajout-user.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p>Clique-droit Propriétés sur l&rsquo;user :</p>
<ul>
<li>Mettre le plus de renseignement possibles pour avoir quelque chose de complet, fortement apprécié des users.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Créer un groupe de sécurité</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Créer un groupe DSI et un groupe ServiceIT. Mettre ServiceIT dépendant du groupe DSI</td>
<td style="text-align:center">
<a href="#image-59dfae073f01d1061a586cf97c720264" class="lightbox-link">
<img src="../at2/at2e5/ad/008-groupes.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-59dfae073f01d1061a586cf97c720264">
<img src="../at2/at2e5/ad/008-groupes.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
<tr>
<td style="text-align:center">Ajouter l&rsquo;utilisateur dans le groupe ServiceIT</td>
<td style="text-align:center">
<a href="#image-fb3acbd6f26fb33fce0ac5976f599f5c" class="lightbox-link">
<img src="../at2/at2e5/ad/009-petit-groupe.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-fb3acbd6f26fb33fce0ac5976f599f5c">
<img src="../at2/at2e5/ad/009-petit-groupe.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p><em>AzureAD vas aspirer le compte d&rsquo;Arthur PENDRAGON et le synchroniser avant sa boite mail</em></p>
<h2 id="gpo-et-transferts-de-fichier">GPO ET TRANSFERTS DE FICHIER</h2>
<p>
<a href="#image-589d4de7444633fa31493dc11a7c5cc2" class="lightbox-link">
<img src="../at2/at2e5/ad/010-annuaire-AD.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-589d4de7444633fa31493dc11a7c5cc2">
<img src="../at2/at2e5/ad/010-annuaire-AD.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><em>Tout ce dont on parle n&rsquo;est valable que si l&rsquo;entreprise n&rsquo;a pa Teams ou Sharepoint</em></p>
<p><strong>PC Portables ou Fixes</strong></p>
<ul>
<li>Besoins du personnel :
<ul>
<li>Environnement de Bureau</li>
<li>Données pures :
<ul>
<li>Personnelles</li>
<li>partagées ou communes ou collectives</li>
</ul>
</li>
<li>Images / Photos</li>
<li>Favoris Internet (Edge)
<em>Tout doit être sur le réseau ! Rien en dur sur le disque du PC</em></li>
</ul>
</li>
</ul>
<p>Côté GPO :</p>
<ul>
<li>Attention : pour les entreprises passant par TEAMS ou SHAREPOINTS pas besoin de GPO car centralisé via les logiciels</li>
<li>Attention : les données doivent être mises sur des serveurs de fichiers donc sur le reseau via GPO
<ul>
<li>GPO = du bureau (va prendre le bureau local et le transposer sur le serveur de fichiers/réseau etc.)</li>
<li>Nécessite gros serveurs de fichiers (baie de stockage) = disques VM pointés vers baie de stockage</li>
<li>VM branchées sur baies en ESX (derrière le cluster ESX il n&rsquo;y a que des baies de stockage) = baie connectée aux ESX
<ul>
<li>Avenir = hyperconvergence (on s&rsquo;affranchit des baies) = VMWare sait embarquer le stockage dans son noyau, stockage embarqué dans les clusters VSAN qui deviennent aussi baie (baie de stockahe imbriquée à VMWare, disques en full flash)</li>
</ul>
</li>
</ul>
</li>
<li>Attention : les GPO ne proposent pas la redirection des ressources partagées
<ul>
<li>(1) nécessite script powershell pour reconnecter le lecteur réseau (script de connexion dans une GPO)</li>
<li>(2) vous connectez sur le compte de l&rsquo;user directement le lecteur reseau des partages collectifs avec l&rsquo;onglet &hellip;</li>
</ul>
</li>
</ul>
<p><strong>Côté serveur de fichiers</strong></p>
<p>Grosse bête pointe vers une baie de stockage. Elle projète des volumes directement sur le serveur. Et le serveur dans l&rsquo;explorateur Windows va présenter la baie.</p>
<p>Sur le server de fichier: Arborescence dossiers<br>
D: Dossiers Ultisateurs &ndash;&gt; partagé &ndash;&gt; Sécurité NTFS</p>
<ul>
<li>Dossier individuel des utilisateurs &ndash;&gt; Pas de partage &ndash;&gt; Sécurité NTFS</li>
<li>Le dossier pour qu&rsquo;il redescende en GPO doit s&rsquo;appeller avec le SAM (S. Acompte Mail.) &ndash;&gt; %UserName%</li>
<li>Partages &ndash;&gt; partagé &ndash;&gt; Sécurité NTFS</li>
</ul>
<p><strong>Première GPO</strong></p>
<p>Toujours faire ses GPO sur la dernières sous-OU.<br>
Outilis / Gestion des stratégies de Groupes.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Creer une GPO</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-ad0bfb34d70d4841b254804f44d70260" class="lightbox-link">
<img src="../at2/at2e5/ad/011-creer-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-ad0bfb34d70d4841b254804f44d70260">
<img src="../at2/at2e5/ad/011-creer-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p>Clique-droit / Propriétés sur la GPO qui vient d&rsquo;être créée.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Script Powershell</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Mettre le script dans le dossier (en bas l&rsquo;image), puis le charger dans le gestionnaire.</td>
<td style="text-align:center">
<a href="#image-7be0bda818b102c5816a3c3fc7b6b200" class="lightbox-link">
<img src="../at2/at2e5/ad/012-scrip-powershell.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-7be0bda818b102c5816a3c3fc7b6b200">
<img src="../at2/at2e5/ad/012-scrip-powershell.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p>Création de notre arborescence de fichier sur le lecteur C:</p>
<ul>
<li>
<blockquote>
<p>C:\Partages\DSI\Service_IT</p>
</blockquote>
</li>
</ul>
<h3 id="sur-le-dossier-parent-dossiersutilisateurs">Sur le dossier parent DossiersUtilisateurs</h3>
<p>Clique-droit sur le dossier Partages/Propriétés bouton &ldquo;Partage avancé&rdquo; pui cocher &ldquo;Partager ce dossier&rdquo;. Puis bouton &ldquo;Authorisations&rdquo; et Autoriser le contrôle total. Les vrais droits sont gérés par l&rsquo;onglet &ldquo;Sécurité&rdquo;.

<a href="#image-14fd3bf32a45ded5110efadf2597bc22" class="lightbox-link">
<img src="../at2/at2e5/ad/013-partage-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-14fd3bf32a45ded5110efadf2597bc22">
<img src="../at2/at2e5/ad/013-partage-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a>
<em>Ne pas oublier l&rsquo;autorisation partage sinon pas de partage</em></p>
<p>Dans l&rsquo;onglet &ldquo;Sécurité&rdquo;, donc, cliquez le bouton &ldquo;Avancé&rdquo; puis le bouton &ldquo;Désactiver l&rsquo;héritage&rdquo; et choisissez &ldquo;Convertir [&hellip;] sur cet objet&rdquo; puis &ldquo;Appliquer&rdquo; et OK. Cliquez ensuite le bouton &ldquo;Modifier&rdquo; un peu plus haut et là définissez les autorisations finement.</p>
<p>
<a href="#image-2c6f8f0cfd2bb8af17d988183841e29f" class="lightbox-link">
<img src="../at2/at2e5/ad/014-heritage-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-2c6f8f0cfd2bb8af17d988183841e29f">
<img src="../at2/at2e5/ad/014-heritage-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a>
<strong>À mettre partout pour éviter les problèmese :</strong></p>
<ul>
<li>Système: Accès machine, <strong>INDISPENSABLE</strong></li>
<li>Admins du domaine (OM\Admins du domaine) : On fait ajouter, rechercher puis on trouve &ldquo;admins du domaine&rdquo; dans la liste (tous les utilisateurs et groupes sont listés ici).</li>
<li>Utilisateurs Authentifiés (suivant le cas, peut être remplacé par un groupe ou un utilisateur spécifique).</li>
</ul>
<p>
<a href="#image-a87adb90b36206057dd61b03d41d5a8b" class="lightbox-link">
<img src="../at2/at2e5/ad/015-GPO-secu.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a87adb90b36206057dd61b03d41d5a8b">
<img src="../at2/at2e5/ad/015-GPO-secu.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Ajouter/Avancé/Recherche/Utilisateurs authentifiés/OK</li>
</ul>
<p>
<a href="#image-dc044aa27f6990379e6ed9d116951903" class="lightbox-link">
<img src="../at2/at2e5/ad/016-user-auth-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-dc044aa27f6990379e6ed9d116951903">
<img src="../at2/at2e5/ad/016-user-auth-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<h3 id="sur-le-dossier-enfant-dsi">Sur le dossier enfant DSI</h3>
<p>
<a href="#image-75fea00915d6fbf86758241b578b4e44" class="lightbox-link">
<img src="../at2/at2e5/ad/017-GPO-dsi-secu.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-75fea00915d6fbf86758241b578b4e44">
<img src="../at2/at2e5/ad/017-GPO-dsi-secu.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Ne pas laisser le <em>CONTROLE TOTAL</em> pour les utilisateurs car cela leur donne accès à l&rsquo;onglet de sécurité ce qui est une faille de sécuité énorme.</strong></p>
<h3 id="faire-la-même-procédure-pour-le-dossier-enfant-service_it">Faire la même procédure pour le dossier enfant Service_IT</h3>
<p>On vas s&rsquo;occuper de l&rsquo;arborescence des dossiers utisateurs :</p>
<ul>
<li>On crée le dossier à la racine du disque :
<ul>
<li>
<blockquote>
<p>C:\DossiersUtilisateurs</p>
</blockquote>
</li>
</ul>
</li>
<li>On applique le partage sur ce dossier (comme vu précedemment).</li>
<li>Sécurité :
<ul>
<li>On désactive l&rsquo;héritage (comme vu précédemment).</li>
<li>On active la sécurité système, administrateur du domaine et utilisateurs authentifiés.</li>
</ul>
</li>
<li>Dans le dossier parent, on crée un dossier enfant avec le SAM de l&rsquo;utilisateur (apendragon).
<ul>
<li>On gère la sécurité (comme vu précedemment) mais on enlève l&rsquo;utilisateur authentifié et qu&rsquo;on remplace par l&rsquo;user, avec les rêgles qui vont bien (tout sauf <em>contrôle total</em>)</li>
</ul>
</li>
</ul>
<p>
<a href="#image-eba8e44ba5ec85aeb23e05bcb1827d2b" class="lightbox-link">
<img src="../at2/at2e5/ad/018-secu-user-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-eba8e44ba5ec85aeb23e05bcb1827d2b">
<img src="../at2/at2e5/ad/018-secu-user-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<h3 id="quotas">Quotas</h3>
<p>Sur C: Clique-droit/propriétés/onglet &ldquo;Quota&rdquo; :</p>
<ul>
<li>Afficher les paramètres de quota</li>
<li>Cocher Activer la gestion</li>
<li>Refuser de l&rsquo;espace disque &hellip;</li>
</ul>
<p>Si on ne rend pas l&rsquo;utilisateur propriétaire de son dossier, il n&rsquo;aura pas son quota.
Pour faire de l&rsquo;individuel, il faut cliquer-droit sur l&rsquo;user pour gérer son espace disque.</p>
<p>
<a href="#image-506fad676c64e70f5196c8472e462eb3" class="lightbox-link">
<img src="../at2/at2e5/ad/019-quota-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-506fad676c64e70f5196c8472e462eb3">
<img src="../at2/at2e5/ad/019-quota-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Clique-droit sur le dossier /Propriétés/Sécurité/Avancé/Modifier et choisir l&rsquo;utilisateur.<br>

<a href="#image-522f0e34f47ca976945252a194cdf491" class="lightbox-link">
<img src="../at2/at2e5/ad/020-proprio-dossier_user.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-522f0e34f47ca976945252a194cdf491">
<img src="../at2/at2e5/ad/020-proprio-dossier_user.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<h3 id="dossiers-des-utilisateurs">Dossiers des utilisateurs</h3>
<p>Ouvrir l&rsquo;éditeur de Gestion des stratégies de groupes
Bureau :</p>
<ul>
<li>Clique-droit/propriétés/Cible
<ul>
<li>Paramêtres: <em>De base</em></li>
<li>Rentrer le chemain d&rsquo;accès à la racine \\WS19\DossiersUtilisateurs</li>
</ul>
</li>
</ul>
<p>
<a href="#image-0e0639d7d38ee280814d985a4109bf74" class="lightbox-link">
<img src="../at2/at2e5/ad/021-proprio-bureau-GPO-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-0e0639d7d38ee280814d985a4109bf74">
<img src="../at2/at2e5/ad/021-proprio-bureau-GPO-1.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Clique-droit/propriétés/Paramètres
<ul>
<li>Décocher <em>Accorder à l&rsquo;utilisateus des droits exclusifs sur Bureau</em> (sinon les admins ne peuvent plus y accèder pour régler des problèmes)</li>
</ul>
</li>
</ul>
<p>
<a href="#image-0a6324da76875ee22ee8a412472a0f21" class="lightbox-link">
<img src="../at2/at2e5/ad/022-proprio-bureau-GPO-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-0a6324da76875ee22ee8a412472a0f21">
<img src="../at2/at2e5/ad/022-proprio-bureau-GPO-2.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Favoris :</p>
<ul>
<li>Clique-droit /propriétés/Cible
<ul>
<li>Paramêtres: <em>De base</em></li>
<li>Rentrer le chemain d&rsquo;accès à la racine \WS19\DossiersUtilisateurs</li>
</ul>
</li>
</ul>
<p>Documents :</p>
<ul>
<li>Clique-droit /propriétés/Cible
<ul>
<li>Paramêtres: <em>De base</em></li>
<li>Rentrer le chemin d&rsquo;accès à la racine \WS19\DossiersUtilisateurs</li>
</ul>
</li>
</ul>
<p>Images :</p>
<ul>
<li>Clique-droit /propriétés/Cible
<ul>
<li>Paramêtres: <em>Suivre les documents</em></li>
</ul>
</li>
</ul>
<p>
<a href="#image-8b4e543eaa0e6b7955c7be1e8e27d72e" class="lightbox-link">
<img src="../at2/at2e5/ad/023-suivre-doc-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-8b4e543eaa0e6b7955c7be1e8e27d72e">
<img src="../at2/at2e5/ad/023-suivre-doc-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Pour le partage colléctif :</p>
<ul>
<li>AD</li>
<li>User / Compte Utilisateurs / Delegue / ComptesUtilisateurs</li>
<li>clique-droit / Propriété / Profil / chemin d&rsquo;accès local
<ul>
<li>Z:\\WS19\Partages\DSI</li>
</ul>
</li>
</ul>
<p>
<a href="#image-244c6e50eeaf4294f0d84e4076cbfd8a" class="lightbox-link">
<img src="../at2/at2e5/ad/024-partage-co-GPO.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-244c6e50eeaf4294f0d84e4076cbfd8a">
<img src="../at2/at2e5/ad/024-partage-co-GPO.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Vérification du bon fonctionnement des GPO :</p>
<ul>
<li>Monter un W10</li>
<li>Créer un user à rattaché au domaine (check dans computer dans l&rsquo;AD pour l&rsquo;arrivée)</li>
<li>Mettre un fichier dans un des dossiers Documents/Images/&hellip;</li>
<li>Check dans l&rsquo;AD s&rsquo;il apparait bien dans l&rsquo;arborescence de l&rsquo;AD par DossierUser</li>
</ul>
<p>
<a href="#image-9837cb7bcaf858166aeea1983642e60a" class="lightbox-link">
<img src="../at2/at2e5/ad/025-win10-resultat.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9837cb7bcaf858166aeea1983642e60a">
<img src="../at2/at2e5/ad/025-win10-resultat.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Ressources :</strong></p>
<ul>
<li><a href="https://www.active-directory.info/comment-bien-entretenir-son-annuaire-active-directory%E2%80%89/" target="_blank">Entretien AD</a></li>
</ul>
<hr>
<h2 id="migration-active-directory-2016-vers-2019-lvl-ingénieur">MIGRATION ACTIVE DIRECTORY 2016 vers 2019 (lvl ingénieur)</h2>
<p><em><strong>Migration de version d&rsquo;AD / Passer de 2016 à 2019</strong></em></p>
<p><strong>Ressources web :</strong></p>
<ul>
<li><a href="https://docs.microsoft.com/fr-fr/windows-server/get-started/install-upgrade-migrate" target="_blank">Docs microsoft : Installer, mettre à niveau ou migrer vers Windows Serveur</a></li>
<li><a href="https://www.system-net.fr/windows-server-2019/" target="_blank">System-net : Migration Windows Server 2019 : Les étapes</a></li>
<li><a href="https://www.zinstall.com/how-to/how-to-server-2016-migration-software-for-windows-server-2003-2008-2012" target="_blank">How to: Migration to Windows Server 2019 / 2016, including applications, profiles, shares and data</a></li>
<li><a href="https://laboiteajb.fr/migration-dune-infra-simple-dun-serveur-active-directory-2012r2-vers-2016/" target="_blank">Migration d’une infra simple d’un serveur Active Directory 2012R2 vers 2016</a></li>
</ul>
<h3 id="elements-de-compréhension-et-étapes-à-suivre">Elements de compréhension et étapes à suivre</h3>
<p><em>Attention : Nécessite de monter de niveau fonctionnel 2012 vers 2016 (niveau fonctionnel toujours au plus haut pour migration)</em></p>
<h4 id="migration-simple">Migration simple</h4>
<p>
<a href="#image-924885e8e664a09c2db509553e476930" class="lightbox-link">
<img src="../at2/at2e5/ad/101-migration-simple.png" alt="*" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-924885e8e664a09c2db509553e476930">
<img src="../at2/at2e5/ad/101-migration-simple.png" alt="*" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Existant</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">DC Principal</th>
<th style="text-align:center">DC secondaire</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Rôle FSMO</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2016</td>
</tr>
</tbody>
</table>
<p><strong>Préparation à la migration</strong></p>
<p>Faire venir une forêt 2019 dans une forêt 2016 = trois étapes exclusives au prinicpal (puisque possède les FSMO) pour préparation :</p>
<ol>
<li>couper les réplications AD entre contollers (1 ligne de commande à passer)</li>
<li>préparer la forêt (1 ligne de commande à passer)</li>
<li>préparer le domaine (1 ligne de commande à passer)</li>
</ol>
<p><strong>Première étape de migration</strong></p>
<ul>
<li>Préparation d&rsquo;un WServer 2019 : NIC, antivirus etc.</li>
<li>Insérer le WServer 2019 en controller de domaine secondaire dans la forêt 2016
<ul>
<li>Va se coller à la forêt 2016</li>
<li>Mode dit &ldquo;mixte&rdquo; (possible de rester ainsi plusieus mois)</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">DC Principal</th>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">DC secondaire</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Rôle FSMO</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2019</td>
</tr>
</tbody>
</table>
<p><strong>Seconde étape de migration</strong></p>
<ul>
<li>On migre les FSMO (les 5) doivent migrer vers DC secondaire 2019
<ul>
<li>Via interface graphique</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">DC principal</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Rôle FSMO</td>
</tr>
<tr>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2019</td>
</tr>
</tbody>
</table>
<p><strong>Troisième étape de migration</strong></p>
<ul>
<li>Rétrogradation du second controller secondaires
<ul>
<li>Plus DNS ni AD</li>
<li>Redevient server simple</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">Server simple</th>
<th style="text-align:center">DC principal</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Rôle FSMO</td>
</tr>
<tr>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2019</td>
</tr>
</tbody>
</table>
<p><strong>Quatrième étape de migration</strong></p>
<ul>
<li>On crash/réinstalle le server simple en WServer2019</li>
<li>On le fait venir en secondaire en 2019</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">DC principal</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Rôle FSMO</td>
</tr>
<tr>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2019</td>
<td style="text-align:center">AD WServer 2019</td>
</tr>
</tbody>
</table>
<ul>
<li>Bis repetita pour le premier controller</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">DC principal</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Rôle FSMO</td>
</tr>
<tr>
<td style="text-align:center">AD WServer 2019</td>
<td style="text-align:center">AD WServer 2019</td>
<td style="text-align:center">AD WServer 2019</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="migration-de-forêts">Migration de forêts</h2>
<ul>
<li>Entreprise : acab.lan</li>
<li>Achat ou fusion : nouveau nom, nécessite une nouvelle forêt (ex. anar.lan)</li>
<li>Annunaire unique, identifiant unique à partir de plusieurs annuaires/identifiants</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Forêt 1</th>
<th style="text-align:center">Forêt 2</th>
<th style="text-align:center">&gt;</th>
<th style="text-align:center">Nouvelle forêt 1</th>
<th style="text-align:center">Nouvele forêt 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">acab.lan</td>
<td style="text-align:center">acab.lan</td>
<td style="text-align:center">&gt;</td>
<td style="text-align:center">anar.lan</td>
<td style="text-align:center">anar.lan</td>
</tr>
<tr>
<td style="text-align:center">Controller 1</td>
<td style="text-align:center">Controller 2</td>
<td style="text-align:center">&gt;</td>
<td style="text-align:center">NvController 1</td>
<td style="text-align:center">NvController 2</td>
</tr>
</tbody>
</table>
<p>
<a href="#image-c6ef192ff0029c1d10a9d7ec3a01be4f" class="lightbox-link">
<img src="../at2/at2e5/ad/201-admt.png" alt="*" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c6ef192ff0029c1d10a9d7ec3a01be4f">
<img src="../at2/at2e5/ad/201-admt.png" alt="*" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Temps long :
<ul>
<li>Mise en place DNS (Zone de stub, redirecteurs conditionnels) + relations d&rsquo;approbation bi-directionnelle entre les deux domaines/forêts = permet la communication entre les deux forêts</li>
<li>Utilisation d&rsquo;un <a href="https://rdr-it.com/admt-outil-de-migration-de-domaine-active-directory/3/" target="_blank">server ADMT</a> pour la migration les objets de la source vers la cible</li>
<li>Installation de <a href="http://pbarth.fr/node/112" target="_blank">Password Export Server</a> : utilitaire de migration des mots de passe</li>
<li>Une fois cela effectué on peut commencer à migrer</li>
</ul>
</li>
<li>On ne supprime les deux controllers de base qu&rsquo;une fois l&rsquo;ensemble de la migration effectuée</li>
</ul>
<h4 id="migration-via-azure-ad">Migration via Azure AD</h4>
<ul>
<li>Azure AD se base sur l&rsquo;AD local</li>
<li>Azure récupère et transpose directement dans Office365</li>
</ul>
<p>
<a href="#image-504a4d2bdfdeadcd77fd43191221dbe9" class="lightbox-link">
<img src="../at2/at2e5/ad/202-migration-via-azureAD.png" alt="*" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-504a4d2bdfdeadcd77fd43191221dbe9">
<img src="../at2/at2e5/ad/202-migration-via-azureAD.png" alt="*" class="lightbox-image" loading="lazy">
</a></p>
<table>
<thead>
<tr>
<th style="text-align:center">DC Principal</th>
<th style="text-align:center">DC secondaire</th>
<th style="text-align:center">&lt;- AZURE AD Source -&gt;</th>
<th style="text-align:center">Office 365</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Rôle FSMO</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">AD WServer 2016</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">local 2019</td>
<td style="text-align:center">local 2019</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<p>
<a href="#image-c99af30b362a1b10e8af9eb261ef6cc4" class="lightbox-link">
<img src="../at2/at2e5/ad/203-staging-server-1.png" alt="*" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c99af30b362a1b10e8af9eb261ef6cc4">
<img src="../at2/at2e5/ad/203-staging-server-1.png" alt="*" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>UPN : obligé de passer par ligne de commande</li>
</ul>
<h3 id="on-va-manipuler---migration-windows-serveur-2016-a-windows-serveur-2019">ON VA MANIPULER - MIGRATION WINDOWS SERVEUR 2016 A WINDOWS SERVEUR 2019</h3>
<p>Sur Windows Serveur 2016<br>
Ouvrir l&rsquo;invite de commande dans la VM et se rendre à la racine de C.</p>
<p>On coupe les réplications :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">repadmin /options WS16 +disable_outbound_repl
</span></span></code></pre></div><p>
<a href="#image-710e479e6647ff4ac7c1497c81b4ca8c" class="lightbox-link">
<img src="../at2/at2e5/ad/204-mig-repadmin.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-710e479e6647ff4ac7c1497c81b4ca8c">
<img src="../at2/at2e5/ad/204-mig-repadmin.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Pour préparer l&rsquo;AD 2016 à recevoir la fôret de 2019.
On charge l&rsquo;ISO de Windows Serveur 2019 dans le lecteur virtuel.<br>
On se met dans le répertoire support puis adprep.</p>
<blockquote>
<p>D:\support\aprep&gt;</p>
</blockquote>
<p>On tape la commande :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">adprep /forestprep
</span></span></code></pre></div><p>
<a href="#image-499817a5e569349c750c50e851dcbdf6" class="lightbox-link">
<img src="../at2/at2e5/ad/205-mig-adprep.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-499817a5e569349c750c50e851dcbdf6">
<img src="../at2/at2e5/ad/205-mig-adprep.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Toujours dans D:\support\adprep&gt; , on met à jour le domaine :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">adprep /domainprep
</span></span></code></pre></div><p>
<a href="#image-e68e08466b0020e7f6c00d797c4a08ad" class="lightbox-link">
<img src="../at2/at2e5/ad/206-mig-domain.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e68e08466b0020e7f6c00d797c4a08ad">
<img src="../at2/at2e5/ad/206-mig-domain.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Ajouter un contrôleur AD 2019 dans notre AD 2016</strong></p>
<p>Maintenant, on peut ajouter un contrôleur AD 2019 dans notre AD 2016.<br>
On réactive les répliques et on y touche plus. Pas besoin de les couper à nouveau, même si on reprends la migration des mois plus tard.<br>
Retour dans C:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">repadmin /options WS16 -
</span></span></code></pre></div><p>
<a href="#image-143d1c7b682eb65dc35141d709a8e0c0" class="lightbox-link">
<img src="../at2/at2e5/ad/207-mig-activrepl.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-143d1c7b682eb65dc35141d709a8e0c0">
<img src="../at2/at2e5/ad/207-mig-activrepl.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>On monte un Windows Serveur 2019.<br>
On désactive le firewall et on met l&rsquo;adresse du controlleur de domaine 2016 en DNS primaire.<br>
On prends une petite sureté, on ping les machines entre elles.</p>
<p>Ensuite, il faut ajouter le Windows Serveur 2019 dans le <strong>domaine</strong> bobdy.lan</p>
<p>
<a href="#image-53806b64bf5db217e8c11648cc553bd0" class="lightbox-link">
<img src="../at2/at2e5/ad/208-mig-mise-domaine.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-53806b64bf5db217e8c11648cc553bd0">
<img src="../at2/at2e5/ad/208-mig-mise-domaine.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Se reconnecter dans le Windows Serveur 2019 en compte bobdy\administrateur.</strong></p>
<p>Installer les rôle AD DS.</p>
<p>Promouvoir en Controlleur de Domaine.<br>
Verifier qu&rsquo;on soit bien dans le bon domaine.</p>
<p>
<a href="#image-e63fe7e6505f326606e322cfcdab970b" class="lightbox-link">
<img src="../at2/at2e5/ad/209-mig-promo-dc.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e63fe7e6505f326606e322cfcdab970b">
<img src="../at2/at2e5/ad/209-mig-promo-dc.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>On passe aux vérifications, pour être sûr que tout se soit bien passé :</p>
<ul>
<li>Dans l&rsquo;AD19, Carte Réseau : mettre l&rsquo;AD 2019 en DNS primaire et l&rsquo;AD 2016 en DNS Secondaire.</li>
<li>Dans l&rsquo;AD19, Gestionnaire DNS: Verifier qu&rsquo;il y ai bien :
<ul>
<li>les zones, les records et les zones inversées.<br>

<a href="#image-f9ac6c47bfc3205cd9325fe51972f17c" class="lightbox-link">
<img src="../at2/at2e5/ad/210-mig-gest-dns-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f9ac6c47bfc3205cd9325fe51972f17c">
<img src="../at2/at2e5/ad/210-mig-gest-dns-1.png" alt="" class="lightbox-image" loading="lazy">
</a></li>
<li>les serveurs de noms

<a href="#image-657015a3256c9dda3eccc449b9af23af" class="lightbox-link">
<img src="../at2/at2e5/ad/211-mig-gest-dns-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-657015a3256c9dda3eccc449b9af23af">
<img src="../at2/at2e5/ad/211-mig-gest-dns-2.png" alt="" class="lightbox-image" loading="lazy">
</a></li>
<li>les suffixes UPN<br>

<a href="#image-ff98da2df76ae8abd4abd6b4256ba64f" class="lightbox-link">
<img src="../at2/at2e5/ad/212-mig-gest-dns-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-ff98da2df76ae8abd4abd6b4256ba64f">
<img src="../at2/at2e5/ad/212-mig-gest-dns-3.png" alt="" class="lightbox-image" loading="lazy">
</a></li>
<li>les sites et services<br>

<a href="#image-76c197c2edcc37452aa9bb289e536433" class="lightbox-link">
<img src="../at2/at2e5/ad/213-mig-gest-dns-4.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-76c197c2edcc37452aa9bb289e536433">
<img src="../at2/at2e5/ad/213-mig-gest-dns-4.png" alt="" class="lightbox-image" loading="lazy">
</a></li>
<li>les réplications</li>
<li>les OU et sous-OU</li>
<li>Dans l&rsquo;AD 2016, dans les paramêtres de carte réseau, mettre comme DNS secondaire l&rsquo;AD 2019.</li>
</ul>
</li>
</ul>
<p><strong>MIGRATION DES ROLES FSMO DE l&rsquo;AD2016 à L&rsquo;AD2019</strong></p>
<p>Le premier rôle a migrer est caché. Il faut donc le faire apparaitre via une <em>petite commande</em>. Ouvrir l&rsquo;invite de commande et se renre à la racine C:\</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">regsvr32 schmmgmt.dll
</span></span></code></pre></div><p>On vas lancer une console vierge :</p>
<table>
<thead>
<tr>
<th style="text-align:center">windows + R et <strong>mmc</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-d52e0e8a37cbe2138d5341e2d92df0d3" class="lightbox-link">
<img src="../at2/at2e5/ad/214-winR.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d52e0e8a37cbe2138d5341e2d92df0d3">
<img src="../at2/at2e5/ad/214-winR.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">Faire &ldquo;Ajouter[&hellip;]enfichables&rdquo; puis ajouter le Schéma Active Directory</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-47d6dd9d04442b37b114c5193edad776" class="lightbox-link">
<img src="../at2/at2e5/ad/215-fsmo-mmc-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-47d6dd9d04442b37b114c5193edad776">
<img src="../at2/at2e5/ad/215-fsmo-mmc-1.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">Clique-droit sur &ldquo;Schéma Active Directory&rdquo;, Changer de contrôleur de domaine Active Directory</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-6c0e975395c0c0c45856053612230044" class="lightbox-link">
<img src="../at2/at2e5/ad/216-fsmo-mmc-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-6c0e975395c0c0c45856053612230044">
<img src="../at2/at2e5/ad/216-fsmo-mmc-2.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">Clique-droit sur &ldquo;Schéma Active Directory&rdquo;, Maitre d&rsquo;Opérations</th>
<th style="text-align:center">Cliquez sur Modifier</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-82483e58ddbd8deae0d57d8b455a0135" class="lightbox-link">
<img src="../at2/at2e5/ad/217-fsmo-mmc-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-82483e58ddbd8deae0d57d8b455a0135">
<img src="../at2/at2e5/ad/217-fsmo-mmc-3.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">
<a href="#image-b6bdd0e983bf740638ec8e0dc4ef2e45" class="lightbox-link">
<img src="../at2/at2e5/ad/218-fsmo-mmc-4.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-b6bdd0e983bf740638ec8e0dc4ef2e45">
<img src="../at2/at2e5/ad/218-fsmo-mmc-4.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p><strong>2ème ROLE</strong></p>
<p>Dans Domaines et Approbations Active Directory
Clique-droit, Changer de contrôleur de domaine Active Directory et promouvoir l&rsquo;AD 2019
Clique droit, Maitre d&rsquo;Opérations, Cliquez sur Modifier</p>
<p><strong>3 DERNIERS ROLES</strong></p>
<p>Dans Utilisateurs et ordinateurs Active Directory
Clique-droit, Changer de contrôleur de domaine Active Directory et promouvoir l&rsquo;AD 2019
Clique-droit sur notre nom de domaine, Maitre d&rsquo;opérations:</p>
<ul>
<li>RID : Modifier, OUI, OK</li>
<li>CDP: Modifier, OUI, Ok</li>
<li>Infrastructure: Modifier, OUI, Ok</li>
</ul>
<p>
<a href="#image-47bf2f5c5f26093db7f12a3b4b42d824" class="lightbox-link">
<img src="../at2/at2e5/ad/219-fsmo-mmc-5.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-47bf2f5c5f26093db7f12a3b4b42d824">
<img src="../at2/at2e5/ad/219-fsmo-mmc-5.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>RETROGRADATION DE WINDOWS SERVEUR 2016</strong></p>
<p>Gestionnaire de Serveurs, Gérer, Supprimer des rôles et des fonctionnalités.
Il nous propose une méthode de rétrogradation à la décoche.</p>
<p>Décocher Service AD DS<br>

<a href="#image-7f3571800a9086df36f95858a3d5d24a" class="lightbox-link">
<img src="../at2/at2e5/ad/220-mig-retro-AD-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-7f3571800a9086df36f95858a3d5d24a">
<img src="../at2/at2e5/ad/220-mig-retro-AD-1.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Cocher &ldquo;Procéder à la suppression&rdquo;<br>

<a href="#image-a0a26b315fac6649f322c84b64618e16" class="lightbox-link">
<img src="../at2/at2e5/ad/221-mig-retro-AD-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a0a26b315fac6649f322c84b64618e16">
<img src="../at2/at2e5/ad/221-mig-retro-AD-2.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Cliquez sur Retrograder<br>

<a href="#image-13e4d0f058022dd1a69dfdd1bdb4a26f" class="lightbox-link">
<img src="../at2/at2e5/ad/222-mig-retro-AD-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-13e4d0f058022dd1a69dfdd1bdb4a26f">
<img src="../at2/at2e5/ad/222-mig-retro-AD-3.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Enfin refaire supprimer les rôles et décocher les deux rôles et cette fois-ci il ne vas pas discuter.<br>
On va dans les paramêtres de carte réseau et on retire l&rsquo;adresse IP du DNS du Windows Serveur 2016.<br>

<a href="#image-9ca4f7471ae70ae4eb8d54a4acbc4910" class="lightbox-link">
<img src="../at2/at2e5/ad/223-mig-retro-AD-4.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9ca4f7471ae70ae4eb8d54a4acbc4910">
<img src="../at2/at2e5/ad/223-mig-retro-AD-4.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>QUELQUES NETOYAGES SUR LE NOUVEAU CONTROLLEUR PRINCIPALE WINDOWS 2019</strong></p>
<p>Gestionnaire DNS<br>
Clique-droit sur <strong>bobdy.lan</strong> et vérifier que dans les serveurs de noms, l&rsquo;ancien serveur 2016 n&rsquo;y soit plus et sinon supprimez le.<br>
Idem dans <strong>bobdy.fr</strong></p>
<p>Sites and Services Active Directory<br>
Supprimez le serveur WS16.<br>

<a href="#image-6c83d6d86d2f1e3219a181e7ce0fe4dd" class="lightbox-link">
<img src="../at2/at2e5/ad/224-net-AD19.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-6c83d6d86d2f1e3219a181e7ce0fe4dd">
<img src="../at2/at2e5/ad/224-net-AD19.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Utilisateur et ordinateurs Active Directory<br>
Supprimez le serveur des computers.</p>
<p>Gestionnaire DNS
Supprime le record du Windows Serveur 2019</p>
<table>
<thead>
<tr>
<th style="text-align:center"><em><strong>Dernière opération, dans Domaines et approbations Active Directory, clique-droit, augmenté le niveau fonctionnel de la forêt. Sur une migration AD2016 à AD2019, il n&rsquo;y en a pas besoin. Par contre de AD2008 à AD2012, deAD2012 à AD2012R2 et AD2012R2 à AD2016 il y a un niveau fonctionnel à monter.</strong></em></th>
</tr>
</thead>
</table>
<h3 id="on-va-maniper---migration-inter-foret">ON VA MANIPER - MIGRATION INTER-FORET</h3>
<p><strong>Pour supprimer une OU :</strong> <em>Affichage, fonctionnalités avancées, clique-droit sur propriétés l&rsquo;OU désirée, supprimer, onglet sécurité, décoché la case.</em></p>
<p><strong>Préparation de la base pour l&rsquo;AD19 source et cible :</strong></p>
<ul>
<li>Désactiver les firewalls des 2 Windows Serveur.</li>
<li>Sur la carte réseau du WS19CIBLE, on fixe l&rsquo;IP: 192.168.20.53</li>
<li>Renommerla machine en WS19CIBLE</li>
<li>On installe les rôles Services AD DS et rôles DNS</li>
<li>Promouvoir en contrôleur de domaine complétement indépendant : <strong>paradise.lan</strong></li>
<li>Faire les réglages de bases classiques</li>
<li>Mettre la réplication à 15 minutes</li>
<li>Créer son subnet dans Sites and Services AD</li>
<li>Créer son domaine commercial dans les suffixes UPN en .fr</li>
<li>On prépare les OU en prévision de la prochaine migration.</li>
<li>Même si ca ne communique pas encore: Mettre sur les deux cartes réseaux, les deux DNS.</li>
</ul>
<p><strong>Contrôleur Source:</strong></p>
<p><em>On va créer une zone de stub</em></p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-03e288857021b12d8c1e817a9330040f" class="lightbox-link">
<img src="../at2/at2e5/ad/225-foret-stub-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-03e288857021b12d8c1e817a9330040f">
<img src="../at2/at2e5/ad/225-foret-stub-1.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">La zone de stub va permettre de joindre la deuxième forêt.</td>
</tr>
<tr>
<td style="text-align:center">
<a href="#image-9cd7d81771bffc70351c2880254baa7d" class="lightbox-link">
<img src="../at2/at2e5/ad/226-foret-stub-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9cd7d81771bffc70351c2880254baa7d">
<img src="../at2/at2e5/ad/226-foret-stub-2.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">On ajoute notre domaine cible <strong>paradise.lan</strong></td>
</tr>
<tr>
<td style="text-align:center">
<a href="#image-70824ba42c7db79a253e0b9c674131a2" class="lightbox-link">
<img src="../at2/at2e5/ad/227-foret-stub-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-70824ba42c7db79a253e0b9c674131a2">
<img src="../at2/at2e5/ad/227-foret-stub-3.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">L&rsquo;adresse IP de notre controlleur cible: 192.168.20.53</td>
</tr>
</tbody>
</table>
<p>Vérifier que la zone est bien tombé dans les Zones de recherches directes.</p>
<p><strong>Contrôleur Cible:</strong></p>
<p><em>Dans le gestionnaire DNS, on va créer un redirecteur conditionnel.</em></p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-54c6c20b3d3a0c512dd301547a6a39b2" class="lightbox-link">
<img src="../at2/at2e5/ad/228-foret-redir-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-54c6c20b3d3a0c512dd301547a6a39b2">
<img src="../at2/at2e5/ad/228-foret-redir-1.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">
<a href="#image-e8937d33bf590c8f9823447ca5e0a185" class="lightbox-link">
<img src="../at2/at2e5/ad/229-foret-redir-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e8937d33bf590c8f9823447ca5e0a185">
<img src="../at2/at2e5/ad/229-foret-redir-2.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p><strong>Contrôleur Source:</strong></p>
<p>On va faire communiquer les deux forêts et les deux domaines.</p>
<p>Domaines et approbations Active Directory<br>
Clique-droit sur la propriété, puis Approbations</p>
<p>
<a href="#image-a0497f8c76a5902a5c1129c9b8d5b2b8" class="lightbox-link">
<img src="../at2/at2e5/ad/230-foret-approb-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a0497f8c76a5902a5c1129c9b8d5b2b8">
<img src="../at2/at2e5/ad/230-foret-approb-1.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-f5c6efcf2e1c27ca54ea914eb03b2f53" class="lightbox-link">
<img src="../at2/at2e5/ad/231-foret-approb-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f5c6efcf2e1c27ca54ea914eb03b2f53">
<img src="../at2/at2e5/ad/231-foret-approb-2.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-4b422e655480d2722958942373a0b6d9" class="lightbox-link">
<img src="../at2/at2e5/ad/232-foret-approb-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-4b422e655480d2722958942373a0b6d9">
<img src="../at2/at2e5/ad/232-foret-approb-3.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-46fed187240d41ebbab0f3ee833aebdf" class="lightbox-link">
<img src="../at2/at2e5/ad/233-foret-approb-4.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-46fed187240d41ebbab0f3ee833aebdf">
<img src="../at2/at2e5/ad/233-foret-approb-4.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-5eccfa6da1eddbecf90297449c040aba" class="lightbox-link">
<img src="../at2/at2e5/ad/234-foret-approb-5.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5eccfa6da1eddbecf90297449c040aba">
<img src="../at2/at2e5/ad/234-foret-approb-5.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-b386e05b9335abe3973ea6297c868f88" class="lightbox-link">
<img src="../at2/at2e5/ad/235-foret-approb-6.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-b386e05b9335abe3973ea6297c868f88">
<img src="../at2/at2e5/ad/235-foret-approb-6.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-d2ff32dceeabe48b50daa49486a14a51" class="lightbox-link">
<img src="../at2/at2e5/ad/236-foret-approb-7.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d2ff32dceeabe48b50daa49486a14a51">
<img src="../at2/at2e5/ad/236-foret-approb-7.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Si la zone d&rsquo;approbation est passé c&rsquo;est que la zone de stub et le redirecteur conditionnel sont bons.</p>
<p>On va vérifier côté Contrôleur Cible :</p>
<ul>
<li>L&rsquo;approbation est faite dans l&rsquo;autre sens.</li>
</ul>
<p>
<a href="#image-29c9f77efe42d0183434551812a501ba" class="lightbox-link">
<img src="../at2/at2e5/ad/237-foret-approb-8.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-29c9f77efe42d0183434551812a501ba">
<img src="../at2/at2e5/ad/237-foret-approb-8.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Sur le contrôleur cible, changer de domaine pour vérifier que les deux forêts communiquent.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-c14572843a7154c23a3f8d9226882135" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb9.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c14572843a7154c23a3f8d9226882135">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb9.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">
<a href="#image-be4de8ea93f5d435eafaf7a43503afb2" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb10.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-be4de8ea93f5d435eafaf7a43503afb2">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb10.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p><strong>GESTION DES DROITS</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">Contrôleur Source</th>
<th style="text-align:center">Contrôle Cible</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-23286cc9ae4981df776e6d701d313f05" class="lightbox-link">
<img src="../at2/at2e5/ad/238-foret-droits-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-23286cc9ae4981df776e6d701d313f05">
<img src="../at2/at2e5/ad/238-foret-droits-1.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">
<a href="#image-29a6506cec840a0bb6e7f5ea5602d016" class="lightbox-link">
<img src="../at2/at2e5/ad/239-foret-droits-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-29a6506cec840a0bb6e7f5ea5602d016">
<img src="../at2/at2e5/ad/239-foret-droits-2.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p>On vas permettre une délégation de contrôle sur le domaine cible, pour rajouter le compte administrateur du domaine source aux OU du domaine cible.</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-f7d38cfb64b8019277c11a0db75424bc" class="lightbox-link">
<img src="../at2/at2e5/ad/240-foret-droits-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f7d38cfb64b8019277c11a0db75424bc">
<img src="../at2/at2e5/ad/240-foret-droits-3.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">
<a href="#image-bcd84119b729329331043e452386c3a0" class="lightbox-link">
<img src="../at2/at2e5/ad/241-foret-droits-4.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-bcd84119b729329331043e452386c3a0">
<img src="../at2/at2e5/ad/241-foret-droits-4.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p><em><strong>Pour afficher l&rsquo;onglet sécurité, il faut faire affichage, fonctionnalité avancée.</strong></em></p>
<p>On rajoute l&rsquo;Administrateur en contrôle total du groupe sécurité. Idem pour le groupe Staff.<br>

<a href="#image-272d96196fb91f052536fe55ac4d4743" class="lightbox-link">
<img src="../at2/at2e5/ad/242-foret-droits-5.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-272d96196fb91f052536fe55ac4d4743">
<img src="../at2/at2e5/ad/242-foret-droits-5.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>On change de domaine, et on donne les mêmes droits aux administrateurs sur les OU du domaine source.<br>

<a href="#image-8a726552d3bd3a43d896b66cfe4744c7" class="lightbox-link">
<img src="../at2/at2e5/ad/243-foret-droits-6.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-8a726552d3bd3a43d896b66cfe4744c7">
<img src="../at2/at2e5/ad/243-foret-droits-6.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Controleur Source</strong></p>
<p>Dans l&rsquo;OU Builtin, il faut créer un groupe avec le nom netbios du domaine source avec 3 fois $ : BOBDY$$$<br>
Il sert à ADMT(logiciel qui permet la migration) de pouvoir migrer les objets.<br>
Et il ne faut pas mettre de membre ! (very important)<br>

<a href="#image-70e6df6d3ed4e0fe96116244254c6699" class="lightbox-link">
<img src="../at2/at2e5/ad/244-foret-droits-7.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-70e6df6d3ed4e0fe96116244254c6699">
<img src="../at2/at2e5/ad/244-foret-droits-7.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Ouvrir la base de registre (créer la clé si elle n&rsquo;existe pas)</p>
<ul>
<li>
<p>Clé de registre :</p>
<blockquote>
<p>[HKEY_LOCAL_MACHINE\SYSTEM\Current\ControlSet\Control\Lsa]
&ldquo;TcpipClientSupport&rdquo;=dword:00000001</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">
<a href="#image-3daf363701199f673437702a2ff47290" class="lightbox-link">
<img src="../at2/at2e5/ad/245-foret-droits-8.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-3daf363701199f673437702a2ff47290">
<img src="../at2/at2e5/ad/245-foret-droits-8.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
<td style="text-align:center">
<a href="#image-5997c82069f6e0b3a498fb5e9babbc82" class="lightbox-link">
<img src="../at2/at2e5/ad/246-foret-droits-9.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5997c82069f6e0b3a498fb5e9babbc82">
<img src="../at2/at2e5/ad/246-foret-droits-9.png" alt="" class="lightbox-image" loading="lazy">
</a></td>
</tr>
</tbody>
</table>
<p><strong>Contrôleur Source et Cible</strong></p>
<p>Gestion de Stragtégie de groupe.<br>
Il faut mettre une GPO en place, dans le domaine, Domain Controllers, Default Domain Controllers Policy<br>
Clique-droit Modifier<br>
Stratégie
Paramêtre windows<br>
Paramêtre de sécurtié<br>
Stratégie Local<br>
Stratégie d&rsquo;audit<br>
Auditer la gestion des comptes.<br>
Cocher les cases.<br>

<a href="#image-c2c341658ad1bda0364879d792134103" class="lightbox-link">
<img src="../at2/at2e5/ad/247-mig-gpo.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c2c341658ad1bda0364879d792134103">
<img src="../at2/at2e5/ad/247-mig-gpo.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Ligne de Commande</strong></p>
<p>Commande pour désactiver le SID filtering.<br>
On commence par le contrôleur cible.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netdom trust (domaine cible) /domain:(domaine source) /quarantine:no /usero: (compte admin du controleur cible) /passwordo: (password du compte admin du controleur cible)
</span></span></code></pre></div><p>donc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netdom trust paradise.lan /domain:bobdy.lan /quarantine:no /usero:administrateur /passwordo:Dadfba16
</span></span></code></pre></div><p>
<a href="#image-b54d9cb1a1209a9fbf97efde5af6a96d" class="lightbox-link">
<img src="../at2/at2e5/ad/248-mig-cmd-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-b54d9cb1a1209a9fbf97efde5af6a96d">
<img src="../at2/at2e5/ad/248-mig-cmd-1.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Même commande pour le contrôleur source. (évidemment on adapte la commande.)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netdom trust bobdy.lan /domain:paradise.lan /quarantine:no /usero:administrateur /passwordo:Dadfba16
</span></span></code></pre></div><p>Commande pour activer le SID History :<br>
On commence par le contrôleur source.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netdom trust (domain source) /domain:(domaine cible) /enablesidhistory:yes /usero:(compte source) /passwordo:(password source)
</span></span></code></pre></div><p>donc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netdom trust bobdy.lan /domain:paradise.lan /enablesidhistory:yes /usero:administrateur /passwordo:Dadfba16
</span></span></code></pre></div><p>
<a href="#image-35f417526e71869b22ea4782504300f1" class="lightbox-link">
<img src="../at2/at2e5/ad/249-mig-cmd-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-35f417526e71869b22ea4782504300f1">
<img src="../at2/at2e5/ad/249-mig-cmd-2.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Même commande pour le contrôleur cible. (évidemment on adapte la commande.)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netdom trust paradise.lan /domain:bobdy.lan /enablesidhistory:yes /usero:administrateur /passwordo:Dadfba16
</span></span></code></pre></div><p><strong>ADMT</strong></p>
<p>Cloner un windows serveur 2016 et l&rsquo;appeller ADMT<br>
Désactiver le pare-feu et régler la carte réseau. (192.168.20.54/24 et DNS : contrôleur cible)<br>
On lui donne le nom ADMT et on le met dans le domaine cible (paradise.lan)<br>
On redemarre.<br>
Et on se log en nomdedomaine\administrateur (paradise\administrateur)</p>
<p>AMDT fonctionnant avec une BDD, il faut lui installer un SQL express.<br>
<a href="https://www.microsoft.com/fr-fr/download/details.aspx?id=55994" target="_blank">Lien SQL Server Express</a><br>
<a href="https://www.microsoft.com/fr-fr/download/details.aspx?id=56570" target="_blank">Lien ADMT</a><br>
<a href="https://www.microsoft.com/en-us/download/details.aspx?id=1838" target="_blank">Lien PES</a></p>
<p>On installe SQL express. (Déclaré en instance et serveur ADMT)<br>
On install ADMT (ADMT\ADMT)<br>
Une fois ADMT installé on peut le lancer.</p>
<p>
<a href="#image-43eee49c43abbf81846509f0be193943" class="lightbox-link">
<img src="../at2/at2e5/ad/250-admt-install.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-43eee49c43abbf81846509f0be193943">
<img src="../at2/at2e5/ad/250-admt-install.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>On va généré sa clé de chiffrement pour la donner à PASSWORD EXPORT SERVER. C&rsquo;est pour que PES et ADMT puissent migrer<br>
Invite de commande :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">admt key /option:create /sourcedomain:(domainesource) /keyfile:(dans le répertoire que vous voulez)\admt_key /keypassword:(mdp que vous voulez)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">admt key /option:create /sourcedomain:paradise.lan /keyfile:c:\admt_key /keypassword:Dadfba16
</span></span></code></pre></div><p>
<a href="#image-909cb40fd5ac8fced4269ec6b0f192d0" class="lightbox-link">
<img src="../at2/at2e5/ad/251-admt-prep-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-909cb40fd5ac8fced4269ec6b0f192d0">
<img src="../at2/at2e5/ad/251-admt-prep-1.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>On install PES sur le contrôleur de domaine source.<br>
Récuperer le fichier admt_key.pes crée sur le contrôleur ADMT et le mettre dans le contrôleur source pour le charger lors de l&rsquo;installation.<br>
Prendre le compte BOBDY\administrateur (domainesource\administrateur) pour se log à PES (dans la bonne pratique, il faudrait créer un compte PES exprès)</p>
<p>Maintenant, il faut vérifier plusieurs points sur le contrôleur source :</p>
<ul>
<li>
<p>Clé de registre :</p>
<blockquote>
<p>[HKEY_LOCAL_MACHINE\SYSTEM\Current\ControlSet\Control\Lsa]
&ldquo;AllowPasswordExport&rdquo;=dword:00000001</p>
</blockquote>
</li>
</ul>
<p>
<a href="#image-9f1087315189b20c5a459244e8cf5bba" class="lightbox-link">
<img src="../at2/at2e5/ad/252-admt-prep-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9f1087315189b20c5a459244e8cf5bba">
<img src="../at2/at2e5/ad/252-admt-prep-2.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<ul>
<li>Services.msc
<ul>
<li>Il faut vérifier que le service de Password Export Serveur est bien en démarré en automatique et qu&rsquo;il soit démarré.</li>
</ul>
</li>
</ul>
<p>
<a href="#image-a895bce388f6fc31e1665a3d845c39b2" class="lightbox-link">
<img src="../at2/at2e5/ad/253-admt-prep-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a895bce388f6fc31e1665a3d845c39b2">
<img src="../at2/at2e5/ad/253-admt-prep-3.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Migration des utilisateurs</strong></p>
<p>Vérifier que le service, PASSWORD EXPORT SERVICE, soit bien démarré.<br>
Clique droit, assistant de migrations des comptes d&rsquo;utilisateurs</p>
<p>
<a href="#image-d99e6f583d003d19c401bca03d96cbf9" class="lightbox-link">
<img src="../at2/at2e5/ad/254-admt-mig-user-1.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d99e6f583d003d19c401bca03d96cbf9">
<img src="../at2/at2e5/ad/254-admt-mig-user-1.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-76bbb17e841eca0360d5306c0defa276" class="lightbox-link">
<img src="../at2/at2e5/ad/255-admt-mig-user-2.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-76bbb17e841eca0360d5306c0defa276">
<img src="../at2/at2e5/ad/255-admt-mig-user-2.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-fdf68b95932bd9c55f38f69e1d2a5a19" class="lightbox-link">
<img src="../at2/at2e5/ad/256-admt-mig-user-3.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-fdf68b95932bd9c55f38f69e1d2a5a19">
<img src="../at2/at2e5/ad/256-admt-mig-user-3.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-091cfeb926c966b09c7b1d94554a8bca" class="lightbox-link">
<img src="../at2/at2e5/ad/257-admt-mig-user-4.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-091cfeb926c966b09c7b1d94554a8bca">
<img src="../at2/at2e5/ad/257-admt-mig-user-4.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-ad9122c07ccaf3c5aca33b8adf98475b" class="lightbox-link">
<img src="../at2/at2e5/ad/258-admt-mig-user-5.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-ad9122c07ccaf3c5aca33b8adf98475b">
<img src="../at2/at2e5/ad/258-admt-mig-user-5.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-5889858366792f014dd8fcaf66e24066" class="lightbox-link">
<img src="../at2/at2e5/ad/259-admt-mig-user-6.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5889858366792f014dd8fcaf66e24066">
<img src="../at2/at2e5/ad/259-admt-mig-user-6.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-a5ddf331ec5091764666794887917ce4" class="lightbox-link">
<img src="../at2/at2e5/ad/260-admt-mig-user-7.png" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a5ddf331ec5091764666794887917ce4">
<img src="../at2/at2e5/ad/260-admt-mig-user-7.png" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>Une fois les utilisateurs migrés, vérifier que les utilisateurs aient bien leurs nouveaux suffixes UPN.</p>
<p>
<a href="#image-f5ad05004a2cdac2755d527dfbca5bac" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig6.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f5ad05004a2cdac2755d527dfbca5bac">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig6.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-84923ce8c956959d77eeb52e13c748bf" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig7.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-84923ce8c956959d77eeb52e13c748bf">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig7.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Migration des groupes</strong></p>
<p>C&rsquo;est identique.</p>
<p>
<a href="#image-147813f8c6bff4ebacc7419354a1b0de" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-147813f8c6bff4ebacc7419354a1b0de">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-f4557d6a044f16d6f4ec91453f537608" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte1.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f4557d6a044f16d6f4ec91453f537608">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte1.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-90395e1705fe581a773e0ddc2ae5c108" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte2.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-90395e1705fe581a773e0ddc2ae5c108">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte2.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-ac5f18fc0e96e3d445c1316d677afc18" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte3.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-ac5f18fc0e96e3d445c1316d677afc18">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte3.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-763bfb410a581bae3a56c4a9e97d8df3" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte4.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-763bfb410a581bae3a56c4a9e97d8df3">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte4.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-39b4cae12d1096d8a809d06eaccd985f" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte5.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-39b4cae12d1096d8a809d06eaccd985f">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte5.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-c9056d718ad876f41b05d9e1c2c6e9ec" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte6.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c9056d718ad876f41b05d9e1c2c6e9ec">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte6.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p>
<a href="#image-e4fc6589e0a315a7b30b9fc706f0e8d9" class="lightbox-link">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte7.png?raw=true" alt="" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e4fc6589e0a315a7b30b9fc706f0e8d9">
<img src="https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte7.png?raw=true" alt="" class="lightbox-image" loading="lazy">
</a></p>
<p><strong>Ressources</strong></p>
<p><a href="https://activedirectoryfaq.com/2015/10/active-directory-sid-filtering/" target="_blank">AD</a></p>
<h2 id="azure-ad-connect">AZURE AD CONNECT</h2>
<p>Il s&rsquo;installe sur une VM sur un AD local. Il faut le mettre sur un serveur dédié et il ne fait que ca. Il ne s&rsquo;occupe que de la synchro.<br>
On crée un compte AD CONNECT, on le met administrateur général de MS365.</p>
<p><strong>Commande POWERSHELL</strong></p>
<p>Pour forcer la synchro :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Start-ADSyncSyncCycle</span> <span class="n">-PolicyType</span> <span class="n">Delta</span>
</span></span></code></pre></div><p>Pour forcer le changement d&rsquo;UPN :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">set-MsolUserPrincipal</span> <span class="n">-UserPrincipalName</span> <span class="n">ancienUPN</span> <span class="n">-NewUserPrincipalName</span> <span class="n">nouveauUPN</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">set-MsolUserPrincipal</span> <span class="n">-UserPrincipalName</span> <span class="n">k</span><span class="p">.</span><span class="n">novoselic</span><span class="nv">@cefim</span><span class="p">.</span><span class="py">eu</span> <span class="n">-NewUserPrincipalName</span> <span class="n">s</span><span class="p">.</span><span class="n">julie</span><span class="nv">@cefim</span><span class="p">.</span><span class="py">eu</span>
</span></span></code></pre></div>
            <footer class="footline">
            </footer>
          </article>

          </section>
          </section>        </div>
      </main>
    </div>
    <script src="../js/clipboard.min.js" defer></script>
    <script src="../js/perfect-scrollbar.min.js" defer></script>
    <script src="../js/theme.js" defer></script>
  </body>
</html>
